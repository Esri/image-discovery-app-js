//>>built
define("esriviewer/portal/PortalSupport",["dojo/_base/declare","dojo/topic","dojo/_base/connect","dojo/_base/lang","../base/ConfigurationEntryMixin","./PortalSearcher","../base/DataLoaderSupport","esri/dijit/Basemap","esri/dijit/BasemapLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _1([_5,_7],{constructor:function(){this.portalConfiguration=null;this.loadViewerConfigurationData();if(this.portalConfiguration!=null&&_4.isObject(this.portalConfiguration)&&this.portalConfiguration.url!=null&&this.portalConfiguration.url!=""){this.initPortal();}else{VIEWER_UTILS.log("Portal Configuration not found",VIEWER_GLOBALS.LOG_TYPE.ERROR);_2.publish(VIEWER_GLOBALS.EVENTS.PORTAL.INITIALIZED);}},initPortal:function(){require(["esri/arcgis/Portal"],_4.hitch(this,function(_a){this.portal=new _a.Portal(this.portalConfiguration.url);_3.connect(this.portal,"onLoad",_4.hitch(this,this._handlePortalLoaded));}));},_handlePortalLoaded:function(_b){this._createPortalSearcher();this.initListeners();_2.publish(VIEWER_GLOBALS.EVENTS.PORTAL.INITIALIZED);},initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.GET_INSTANCE,_4.hitch(this,this.handleGetPortalInstance));_2.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.LOG_IN,_4.hitch(this,this.handlePortalLogIn));_2.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.LOG_OUT,_4.hitch(this,this.handlePortalLogOut));_2.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.IS_USER_LOGGED_IN,_4.hitch(this,this.handleIsUserLoggedIn));_2.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.GET_BASEMAPS,_4.hitch(this,this.getBasemaps));},getBasemaps:function(_c,_d){if(_c!=null&&_4.isFunction(_c)){var _e=this;var _f=[];if(this.portal){var _10;if(_d!=null){_10="group:"+_d;}else{if(this.portal.basemapGalleryGroupQuery){_10=this.portal.basemapGalleryGroupQuery.replace("id:","group:");}else{return;}}_2.publish(VIEWER_GLOBALS.EVENTS.PORTAL.SEARCH_WEBMAPS,_10,null,null,null,function(_11){if(_11&&_11.results){var _12;var _13={f:"json"};for(var i=0;i<_11.results.length;i++){_12=_11.results[i];_e.loadJsonP(_12.itemDataUrl,_13,_4.partial(function(_14,_15){var _16=[];for(var j=0;j<_15.baseMap.baseMapLayers.length;j++){var _17=new _9({url:_15.baseMap.baseMapLayers[j].url});_16.push(_17);}var _18=new _8({thumbnailUrl:_14.thumbnailUrl,title:_14.title,layers:_16});_f.push(_18);if(_f.length==_11.results.length){_c(_f);}},_12));}}});}}},handleIsUserLoggedIn:function(_19){if(_19!=null&&_4.isFunction(_19)){_19(this.portal&&this.portal.getPortalUser()!=null);}},handlePortalLogOut:function(){this.portal.signOut();_2.publish(VIEWER_GLOBALS.EVENTS.PORTAL.USER_LOGGED_OUT);},handlePortalLogIn:function(_1a){this.portal.signIn().then(_4.hitch(this,function(_1b){_2.publish(VIEWER_GLOBALS.EVENTS.PORTAL.USER_LOGGED_IN,_1b);if(_1a!=null&&_4.isFunction(_1a)){_1a(_1b);}}));},loadViewerConfigurationData:function(){var _1c;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"portal",function(_1d){_1c=_1d;});this.portalConfiguration=_1c;},handleGetPortalInstance:function(_1e){if(_1e!=null&&_4.isFunction(_1e)){_1e(this.portal);}},_createPortalSearcher:function(){this.portalSearcher=new _6();}});});