//>>built
require({cache:{"url:esriviewer/ui/portal/template/PortalPublisherTemplate.html":"<div class=\"portalPublisherOuterContainer\">\r\n    <div class=\"portalPublisherContainer\">\r\n        <div class=\"portalUploadFormContainer\" data-bind=\"visible:publishInputsVisible\">\r\n            <div class=\"portalPublisherActionsContent\">\r\n                <div data-bind=\"text: portalPublishUrl\" class=\"publishToPortalUrlLabel\"></div>\r\n                <div class=\"portalLoginClickContent\" data-bind=\"click:logPortalUserIn, visible: noUserLoggedIn\">\r\n                    <div class=\"commonIcons16 lockGo portalAccountLockIcon\">\r\n                    </div>\r\n                    <span>Log In</span>\r\n                </div>\r\n                <div class=\"portalLoginClickContent\" data-bind=\"click:logPortalUserOut, visible: userLoggedIn\">\r\n                    <div class=\"commonIcons16 lockGo portalAccountLockIcon\">\r\n                    </div>\r\n                    <span>Log Out</span>\r\n                </div>\r\n            </div>\r\n            <div class=\"portalUploadFolderContainer portalUploadInputContainer\">\r\n                <div class=\"portalPublisherLabel\">Folder:</div>\r\n                <select class=\"portalUploadFolderSelect\"\r\n                        data-bind=\"options: userFolders,value:selectedUserFolder,optionsText: 'title', optionsValue: 'id', optionsCaption: 'Root'\"></select>\r\n            </div>\r\n            <div class=\"portalUploadNameContainer portalUploadInputContainer\">\r\n                <div class=\"portalPublisherLabel\">Name:</div>\r\n                <input class=\"portalWebMapPublishTextBox\" type=\"text\" data-bind=\"value:webMapName\"/>\r\n            </div>\r\n            <div class=\"portalUploadTagsContainer portalUploadInputContainer\">\r\n                <div class=\"portalPublisherLabel\">Tags:</div>\r\n                <input class=\"portalWebMapPublishTextBox\" type=\"text\" data-bind=\"value:webMapTags\"/>\r\n            </div>\r\n            <div class=\"portalUploadDescriptionContainer portalUploadInputContainer\">\r\n                <div class=\"portalPublisherLabel\">Description:</div>\r\n                <input class=\"portalWebMapPublishTextBox\" type=\"text\" data-bind=\"value:webMapDescription\"/>\r\n            </div>\r\n            <div class=\"portalUploadButtonContainer\">\r\n                <button data-bind=\"click:showSharingContent,enable:userLoggedIn\" class=\"portalShowPreferencesButton\">\r\n                    Next\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"portalPublishShareContainer\" data-bind=\"visible:sharingContentVisible\">\r\n        <div class=\"portalPublishShareWithLabel\">Share with:</div>\r\n        <div class=\"portalPublishShareForm\">\r\n            <div class=\"publicShareContainer\">\r\n                <input type=\"checkbox\" data-bind=\"checked:shareEveryoneChecked\"/>\r\n\r\n                <span>Everyone (public)</span>\r\n            </div>\r\n            <div class=\"groupShareContainer\">\r\n                <input type=\"checkbox\" data-bind=\"checked:shareWithGroupsChecked\"/>\r\n                <span>These Groups:</span>\r\n\r\n                <div class=\"portalPublishGroupShareListContainer\">\r\n                    <ul class=\"portalGroupShareList\" data-bind=\"foreach: userGroups\">\r\n                        <li class=\"portalPublishGroupItem\">\r\n                            <input type=\"checkbox\" data-bind=\"click:$parent.handleGroupShareToggle\"/>\r\n                            <span data-bind=\"text:$data.title\"></span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div>These settings will replace your current settings.</div>\r\n        <div class=\"portalSubmitShareButtonContainer\">\r\n            <button data-bind=\"click:showPublishInputs\" class=\"portalBackButton\">Back</button>\r\n            <button data-bind=\"click:publishWebMap\" data-bind=\"enable:userLoggedIn\" class=\"portalPublishButton\">\r\n                Publish\r\n            </button>\r\n        </div>\r\n    </div>\r\n</div>\r\n"}});define("esriviewer/ui/portal/PortalPublisherWidget",["dojo/_base/declare","dojo/text!./template/PortalPublisherTemplate.html","dojo/_base/lang","dojo/_base/json","dojo/topic","../base/UITemplatedWidget","./model/PortalPublisherViewModel","./base/PortalWebMapAnnotationSupport","esri/dijit/Basemap","esri/IdentityManager","esri/request","esri/layers/ArcGISImageServiceLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_6,_8],{publishMixinParameters:{type:"Web Map",typeKeywords:"Web Map, Explorer Web Map, Map, Online Map, ArcGIS Online",overwrite:false,f:"json",description:"",accessInformation:"",licenseInfo:"",thumbnailURL:""},publishTextMixinParameters:{version:"1.8"},thumbnailMixinParameters:{format:"png",size:"200,133",cm:0,nbbox:"",bbox:"",sr:""},templateString:_2,postCreate:function(){this.inherited(arguments);this.viewModel=new _7();this.viewModel.on(this.viewModel.PUBLISH_WEB_MAP,_3.hitch(this,this.handlePublishWebMap));ko.applyBindings(this.viewModel,this.domNode);if(_a!=null&&_a.credentials!=null&&_a.credentials.length>0){this.viewModel.logPortalUserIn();}},initListeners:function(){this.inherited(arguments);_5.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.LOG_OUT,_3.hitch(this,this.setNoUserLoggedIn));_5.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.USER_LOGGED_IN,_3.hitch(this,this.setUserLoggedIn));},loadViewerConfigurationData:function(){this.inherited(arguments);var _d=null;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"portalPublisher",function(_e){_d=_e;});if(_d!=null&&_3.isObject(_d)){if(_d.publishVersion!=null){this.publishTextMixinParameters.version=_d.publishVersion;}if(_d.webMapProperties!=null&&_3.isObject(_d.webMapProperties)){_3.mixin(this.publishMixinParameters,_d.webMapProperties);}}},setUserLoggedIn:function(_f){if(_f!=null){this.currentPortalUser=_f;var _10=this.currentPortalUser.portal;if(_10!=null&&_3.isObject(_10)){this.viewModel.portalPublishUrl(_10.portalHostname);}this.viewModel.setUserLoggedIn();this.getUserFolders();this.getUserGroups();}else{this.setNoUserLoggedIn();}},setNoUserLoggedIn:function(){this.viewModel.setNoUserLoggedIn();this.currentPortalUser=null;this.viewModel.portalPublishUrl("");this.viewModel.userFolders.removeAll();this.viewModel.userGroups.removeAll();},handlePublishWebMap:function(){var _11;_5.publish(VIEWER_GLOBALS.EVENTS.PORTAL.GET_INSTANCE,function(_12){_11=_12;});if(_11==null){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Cannot publish item. No Portal instance configured.");return;}var _13=this.getUserTokenAndId();if(_13==null||_13.token==null||_13.id==null){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Cannot publish item. Could not retrieve portal token/id.");return;}var _14=_13.token;var _15=_13.id;var _16=_11.url;var _17=null;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.GET_EXTENT,function(ext){_17=ext;});_5.publish(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_LAT_LON,_17,_3.hitch(this,function(_18){var _19=this.getWebMapParameters(_16,_18[0]);_19.token=_14;this.sendAddItemRequest(_19,_16,_15,_14);}));},sendAddItemRequest:function(_1a,_1b,_1c,_1d){var _1e=VIEWER_UTILS.joinUrl(_1b,VIEWER_GLOBALS.DEFAULT_PORTAL_ENDPOINTS.USER_CONTENT_PREPEND);var _1f=this.viewModel.selectedUserFolder();_1e=VIEWER_UTILS.joinUrl(_1e,_1c);if(_1f!=null&&_1f!=""){_1e=VIEWER_UTILS.joinUrl(_1e,_1f);}_1e=VIEWER_UTILS.joinUrl(_1e,VIEWER_GLOBALS.DEFAULT_PORTAL_ENDPOINTS.ADD_ITEM_PART_APPEND);_b({url:_1e,content:_1a,callbackParamName:"callback",load:_3.hitch(this,this._handleAddItemComplete,_1b,_1c,_1d),error:_3.hitch(this,this._handleAdItemError)},{usePost:true});},_handleAddItemComplete:function(_20,_21,_22,_23){this.viewModel.showPublishInputs();if(_23.success){this.submitSharingParameters(_20,_21,_22,_23);this.viewModel.showPublishInputs();_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Successfully Published Item");}else{if(_23.error){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,_23.error.message);}else{_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Could not publish item");}}},_handleAdItemError:function(err){this.viewModel.showPublishInputs();if(err.message){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,err.message);}else{_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Could not publish item");}},submitSharingParameters:function(_24,_25,_26,_27){var _28=_27.id;if(_28!=null&&_28!=""){var _29=false;var _2a={f:"json",items:_28,token:_26};var _2b=this.viewModel.shareEveryoneChecked();var _2c=this.viewModel.shareWithGroupsChecked();if(!_2b&&!_2c){return;}if(_2b){_29=true;_2a.everyone=true;}if(_2c){var _2d=[];var _2e=this.viewModel.userGroups();var _2f;for(var i=0;i<_2e.length;i++){_2f=_2e[i];if(_2f.selected){_2d.push(_2f.id);}}if(_2d.length>0){_29=true;_2a.groups=_2d.join(",");}}if(_29){var _30=VIEWER_UTILS.joinUrl(_24,VIEWER_GLOBALS.DEFAULT_PORTAL_ENDPOINTS.USER_CONTENT_PREPEND);_30=VIEWER_UTILS.joinUrl(_30,_25);_30=VIEWER_UTILS.joinUrl(_30,VIEWER_GLOBALS.DEFAULT_PORTAL_ENDPOINTS.USER_SHARE_APPEND);var _31=_b({url:_30,content:_2a,callbackParamName:"callback",load:_3.hitch(this,function(_32){var _33=_32.results;if(_3.isArray(_33)&&_33.length>0){if(!_33[0].success){var _34=(_33[0].error&&_33[0].error.message)?_33[0].error.message:"Error Sharing Content.";_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,_34);}else{_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Successfully Shared Item.");}}}),error:_3.hitch(this,function(err){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Error Sharing Content.");})},{usePost:true});}}},getUserFolders:function(){if(this.currentPortalUser){this.currentPortalUser.getFolders().then(_3.hitch(this,function(_35){var _36;for(var i=0;i<_35.length;i++){this.viewModel.userFolders.push(_35[i]);}}));}},getUserGroups:function(){if(this.currentPortalUser){this.currentPortalUser.getGroups().then(_3.hitch(this,function(_37){var _38;for(var i=0;i<_37.length;i++){_38=_37[i];if(_38&&!_38.isViewOnly){this.viewModel.userGroups.push({title:_38.title,id:_38.id,selected:false});}}}));}},getWebMapParameters:function(_39,_3a){var _3b=_3.mixin({services:[]},this.thumbnailMixinParameters);var _3c=_3.mixin({},this.publishMixinParameters);var _3d=_3.mixin({operationalLayers:[],baseMap:{baseMapLayers:[],title:""}},this.publishTextMixinParameters);var _3e=this.viewModel.webMapName();_3c.item=_3e.toLowerCase()+"_"+new Date().getTime();var _3f=this.viewModel.webMapTags();if(_3f!=null){_3c.tags=_3f;}else{_3c.tags="";}var _40=this.viewModel.webMapDescription();if(_40!=null){_3c.snippet=_40;}else{_3c.snippet="";}var _41=this.getOperationalLayers();var _42;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT,_3.hitch(this,function(_43){_42=[_43];}));var _44=this.getExternalLayers();if(_44!=null&&_3.isArray(_44)&&_44.length>0){if(_41==null){_41=[];}_41=_41.concat(_44);}if(_3a){var _45=_3a.xmin+","+_3a.ymin+","+_3a.xmax+","+_3a.ymax;_3c.extent=_45;_3b.nbbox=_45;_3b.bbox=_45;}var i;var _46;var _47;var _48;var _49=this.createAnnotationLayer(_39);if(_49!=null&&_3.isObject(_49)){_3d.operationalLayers.push(_49);}if(_3.isArray(_42)){var _4a;var _4b;for(i=0;i<_42.length;i++){_46=_42[i];if(_46==null){continue;}_47=_46.label;if(_47==null||_47==""){_47=_46.title?_46.title:(_46.name?_46.name:"Base Map");}if(i==0){_48=_47;}if(_46 instanceof _9&&_46.layers!=null&&_46.layers.length>0){var _4c=_46.layers[0];_4a=_4c.url;_4b=_4c.opacity;}else{if(_46.url!=null){_4a=_46.url;_4b=_46.opacity;}else{continue;}}_3d.baseMap.baseMapLayers.push({url:_4a,visibility:true,opacity:_4b!=null?_4b:1});_3b.services.push({service:_4a,extra:"",wrap:true,opacity:_4b!=null?_4b:1,title:_47});}_3d.baseMap.title=_48;}if(_3.isArray(_41)){for(i=0;i<_41.length;i++){_46=_41[i];if(_46==null||_46.url==null){continue;}var _4d=this.layerToWebMapJson(_46);if(_4d){_3d.operationalLayers.push(_4d);_3b.services.push({service:_4d.url,extra:"&transparent=true",wrap:true,opacity:_4d.opacity});}}}_3c.thumbnailURL=VIEWER_UTILS.joinUrl(_39,VIEWER_GLOBALS.DEFAULT_PORTAL_ENDPOINTS.PRINT_SERVICE_APPEND)+"?json="+_4.toJson(_3b);_3c.text=_4.toJson(_3d);_3c.title=_3e;return _3c;},getOperationalLayers:function(){var _4e;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.OPERATIONAL.GET,_3.hitch(this,function(_4f){_4e=_4f;}));return _4e;},getUserTokenAndId:function(){if(_a&&_a.credentials!=null&&_3.isArray(_a.credentials)){if(_a.credentials.length>0){var _50=_a.credentials[0];return {token:_50.token,id:_50.userId};}}return null;},getExternalLayers:function(){return [];},layerToWebMapJson:function(_51){if(_51&&_51.url){var _52=_51.label;if(_52==null||_52==""){_52=_51.name;}var _53={url:_51.url,id:_51.id,visibility:_51.visible,opacity:_51.opacity!=null?_51.opacity:1,title:_52};if(_51 instanceof _c){if(_51.bandIds!=null){_53.bandIds=_51.bandIds;}if(_51.mosaicRule!=null&&_3.isObject(_51.mosaicRule)){_53.mosaicRule={mosaicMethod:_51.mosaicRule.method,ascending:_51.mosaicRule.ascending,lockRasterIds:_51.mosaicRule.lockRasterIds,mosaicOperation:_51.mosaicRule.operation};}}return _53;}else{return null;}}});});