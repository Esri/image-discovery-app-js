//>>built
define("esriviewer/ui/portal/base/PortalWebMapAnnotationSupport",["dojo/_base/declare","dojo/topic","dojo/_base/lang","./PortalWebMapAnnotationTemplates","esri/geometry/Polygon","esri/geometry/Polyline","esri/geometry/Point","esri/geometry/Extent","esri/SpatialReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _1([_4],{pointIconUrl:"",constructor:function(){var _a=null;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"portalPublisher",function(_b){_a=_b;});if(_a!=null&&_3.isObject(_a)){this.pointIconUrl=_a.pointIconUrl;}},createAnnotationLayer:function(_c){var _d;_2.publish(VIEWER_GLOBALS.EVENTS.DRAW.USER.GET_USER_GRAPHICS,_3.hitch(this,function(_e){_d=_e;}));if(_d==null||!_3.isArray(_d)){return null;}var _f=this._sortGeometries(_d);if(_f==null){return null;}if(_f.points.length==0&&_f.lines.length==0&&_f.polygons.length==0){return null;}var _10=_3.mixin({id:("mapNotes_"+new Date().getTime()),featureCollection:{layers:[]}},this.annotationLayerRootMixin);var _11=this.getLineLayerTemplate();var _12=this.getPointLayerTemplate();if(_c!=""){this.preprocessPointLayerDefinition(_c,_12);}var _13=this.getPolygonLayerTemplate();var _14=this.getTextLayerTemplate();if(_f.points.length>0){this._applyPointGeometriesToLayer(_f.points,_12);_12.nextObjectId=1;}if(_f.lines.length>0){this._applyLineGeometriesToLayer(_f.lines,_11);_12.nextObjectId=1;}if(_f.polygons.length>0){this._applyPolygonGeometriesToLayer(_f.polygons,_13);_12.nextObjectId=1;}_10.featureCollection.layers.push(_13);_10.featureCollection.layers.push(_11);_10.featureCollection.layers.push(_14);_10.featureCollection.layers.push(_12);return _10;},_applyPolygonGeometriesToLayer:function(_15,_16){if(_3.isObject(_16)&&_16.featureSet!=null&&_3.isObject(_16.featureSet)&&_16.featureSet.features!=null&&_3.isArray(_16.featureSet.features)){var _17;for(var i=0;i<_15.length;i++){_17=_15[i];_16.featureSet.features.push({geometry:{rings:_17.rings,spatialReference:{wkid:_17.spatialReference.wkid}},attributes:{TYPEID:0,VISIBLE:1,TITLE:"Area",OBJECTID:i}});}}},_applyLineGeometriesToLayer:function(_18,_19){if(_3.isObject(_19)&&_3.isObject(_19.featureSet)&&_3.isArray(_19.featureSet.features)){var _1a;for(var i=0;i<_18.length;i++){_1a=_18[i];_19.featureSet.features.push({geometry:{paths:_1a.paths,spatialReference:{wkid:_1a.spatialReference.wkid}},attributes:{TYPEID:0,VISIBLE:1,TITLE:"Line",OBJECTID:i}});}}},_applyPointGeometriesToLayer:function(_1b,_1c){if(_3.isObject(_1c)&&_3.isObject(_1c.featureSet)&&_3.isArray(_1c.featureSet.features)){var _1d;for(var i=0;i<_1b.length;i++){_1d=_1b[i];_1c.featureSet.features.push({geometry:{x:_1d.x,y:_1d.y,spatialReference:{wkid:_1d.spatialReference.wkid}},attributes:{TYPEID:0,VISIBLE:1,TITLE:"Point",OBJECTID:i}});}}},_sortGeometries:function(_1e){var _1f={points:[],lines:[],polygons:[]};var _20;for(var i=0;i<_1e.length;i++){_20=_1e[i];if(_3.isObject(_20.geometry)){if(_20.geometry instanceof _5){_1f.polygons.push(_20.geometry);}else{if(_20.geometry instanceof _6){_1f.lines.push(_20.geometry);}else{if(_20.geometry instanceof _7){_1f.points.push(_20.geometry);}else{if(_20.geometry instanceof _8){var _21=this._extentToPolygon(_20.geometry);if(_21!=null){_1f.polygons.push(_21);}}}}}}}return _1f;},_extentToPolygon:function(_22){if(_22==null||!_3.isObject(_22.spatialReference)){return null;}var _23=_22.xmin;var _24=_22.xmax;var top=_22.ymax;var _25=_22.ymin;var _26=_22.spatialReference.wkid;var _27=new _9({wkid:_26});var _28=new _5(_27);var _29=new _7(_23,_25);var _2a=new _7(_23,top);var _2b=new _7(_24,top);var _2c=new _7(_24,_25);_28.addRing([_29,_2a,_2b,_2c,_29]);return _28;},getLineLayerTemplate:function(){var _2d=_3.mixin({nextObjectId:0,featureSet:{geometryType:VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.LINE,features:[]}},this.annotationLayerMixin);var _2e=_3.mixin({templates:[]},this.genericLayerDefinitionMixin);_3.mixin(_2e,this.lineLayerDefinitionMixin);_2d.layerDefinition=_2e;return _2d;},getPointLayerTemplate:function(){var _2f=_3.mixin({nextObjectId:0,featureSet:{geometryType:VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.POINT,features:[]}},this.annotationLayerMixin);var _30=_3.mixin({templates:[]},this.genericLayerDefinitionMixin);_3.mixin(_30,this.pointLayerDefinitionMixin);_2f.layerDefinition=_30;return _2f;},getPolygonLayerTemplate:function(){var _31=_3.mixin({nextObjectId:0,featureSet:{geometryType:VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.POLYGON,features:[]}},this.annotationLayerMixin);var _32=_3.mixin({templates:[]},this.genericLayerDefinitionMixin);_3.mixin(_32,this.polygonLayerDefinitionMixin);_31.layerDefinition=_32;return _31;},getTextLayerTemplate:function(){var _33=_3.mixin({nextObjectId:0,featureSet:{geometryType:VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.POINT,features:[]}},this.annotationLayerMixin);var _34=_3.mixin({templates:[]},this.genericLayerDefinitionMixin);_3.mixin(_34,this.textLayerDefinitionMixin);_34.fields.push({name:"TEXT",type:VIEWER_GLOBALS.ESRI_FIELD_TYPES.STRING,alias:"Text",length:255,editable:true});_33.layerDefinition=_34;return _33;},preprocessPointLayerDefinition:function(_35,_36){if(!_3.isObject(_36)||!_3.isObject(_36.layerDefinition)){return;}var _37=_36.layerDefinition;var _38=false;var _39=false;if(_37.drawingInfo&&_37.drawingInfo.renderer&&_3.isArray(_37.drawingInfo.renderer.uniqueValueInfos)){var _3a;for(var i=0;i<_37.drawingInfo.renderer.uniqueValueInfos.length;i++){_3a=_37.drawingInfo.renderer.uniqueValueInfos[i];if(_3a.label==="Stickpin"){if(_3.isObject(_3a.symbol)){_39=true;_3a.symbol.url=this.pointIconUrl;}}else{if(_3a.label==="Pushpin"){if(_3.isObject(_3a.symbol)){_38=true;_3a.symbol.url=this.pointIconUrl;}}}if(_39&&_38){return;}}}}});});