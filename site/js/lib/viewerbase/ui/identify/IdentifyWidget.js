//>>built
require({cache:{"url:esriviewer/ui/identify/template/IdentifyWigetTemplate.html":"<div>\r\n    <div class=\"defaultTabContainer identifyWidgetTabContainer\" data-bind=\"visible: showTabContainer\">\r\n        <span data-bind=\"click:showQuery, css: {selectedTab: identifyQueryVisible}\">Identify</span>\r\n        <span data-bind=\"click:showResults, css: {selectedTab: identifyResultsVisible}\">Results</span>\r\n    </div>\r\n    <div class=\"identifyQueryContainer\" data-bind=\"visible: identifyQueryVisible\" data-dojo-attach-point=\"identifyQueryContainer\">\r\n        <div class=\"identifyServiceContainer\">\r\n            <div class=\"identifyWidgetLabel\">Map Service</div>\r\n            <select class=\"identifyWidgetSelect\"\r\n                    data-bind=\" options: services ,value:selectedService, optionsText: 'label', optionsValue: 'value', optionsCaption: 'Select A Service'\"></select>\r\n        </div>\r\n        <div class=\"identifyLayerContainer\" data-bind=\"visible:currentServiceIsMapService\">\r\n            <div class=\"identifyWidgetLabel\">Layer</div>\r\n            <select class=\"identifyWidgetSelect\"\r\n                    data-bind=\"options: layers ,value:selectedLayer, optionsText: 'label', optionsValue: 'value'\"></select>\r\n        </div>\r\n        <div class=\"identifyDrawActionsContainer\" data-bind=\"visible: showDrawContainer\">\r\n            <div class=\"commonIcons32 rectangleUnselected fivePixelBorderRadius\"\r\n                 data-bind=\"click: toggleDrawActive, css:{rectangleSelected: drawActive}\"></div>\r\n        </div>\r\n        <div class=\"identifyAdvancedOptionsContainer\" data-bind=\"visible:hasSelectedService\">\r\n            <div class=\"identifyOptionsToggleContainer\" data-bind=\"click:toggleIdentifyAdvancedOptions\">\r\n                <div style=\"float: left\" class=\"commonIcons16 up\"\r\n                     data-bind=\"css: {down: identifyAdvancedOptionsVisible() == true}\"></div>\r\n                <span>Advanced Options</span>\r\n            </div>\r\n            <div data-dojo-attach-point=\"identifyDisplayFieldsContainer\"\r\n                 data-bind=\"visible: identifyAdvancedOptionsVisible() == true\">\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"identifyResultsContainer\" data-dojo-attach-point=\"identifyResultsContainer\"\r\n         data-bind=\"visible: identifyResultsVisible\">\r\n        <div class=\"identifyResultsClearText\" data-bind=\"visible:showClearResults, click:clearResults\">clear results\r\n        </div>\r\n\r\n\r\n    </div>\r\n\r\n</div>"}});define("esriviewer/ui/identify/IdentifyWidget",["dojo/_base/declare","dojo/text!./template/IdentifyWigetTemplate.html","dojo/_base/lang","dojo/_base/Color","dojo/topic","../base/UITemplatedWidget","./model/IdentifyWidgetViewModel","../draw/base/MapDrawSupport","./IdentifyResultsContents","./IdentifyAdvancedOptionsWidget","../../map/base/LayerQueryParameters","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/KMLLayer","esri/layers/WMSLayer","esri/layers/WMSLayer","esri/layers/FeatureLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){return _1([_6,_8],{maxResults:50,firstResultSet:true,templateString:_2,constructor:function(){this.serviceToLayerFieldsCache={};},postCreate:function(){this.inherited(arguments);this.viewModel=new _7();this.viewModel.drawActive.subscribe(_3.hitch(this,this.handleDrawActiveChange));this.viewModel.on(this.viewModel.CLEAR_RESULTS,_3.hitch(this,this.handleClearResults));this.viewModel.showDrawContainer.subscribe(_3.hitch(this,this.handleDrawContainerVisibilityChanged));this.viewModel.identifyResultsVisible.subscribe(_3.hitch(this,this.handleIdentifyResultsVisibilityChanged));this.viewModel.identifyQueryVisible.subscribe(_3.hitch(this,this.handleIdentifyQueryVisibilityChanged));this.viewModel.selectedService.subscribe(_3.hitch(this,this.handleSelectedServiceChanged));this.viewModel.selectedLayer.subscribe(_3.hitch(this,this.handleSelectedLayerChanged));this.loadServices();ko.applyBindings(this.viewModel,this.domNode);this.queryResponseCallback=_3.hitch(this,this.handleQueryResponse);this.queryErrorCallback=_3.hitch(this,this.handleQueryError);var _13;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.GET,function(map){_13=map;});this.map=_13;this.identifyResponseContents=new _9();this.identifyResponseContents.placeAt(this.identifyResultsContainer);this.createIdentifyOptionsWidget();},loadViewerConfigurationData:function(){var _14;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"identifyWidget",function(_15){_14=_15;});if(_14!=null&&_3.isObject(_14)&&_14.maxResults!=null){this.maxResults=_14.maxResults;}},handleSelectedLayerChanged:function(_16){if(this.identifyOptionsWidget==null){return;}var _17=this.viewModel.selectedService();if(_17!=null&&_16!=null){if(this.serviceToLayerFieldsCache[_17.url]&&this.serviceToLayerFieldsCache[_17.url][_16]){var _18=this.serviceToLayerFieldsCache[_17.url][_16];this.identifyOptionsWidget.setFields(_18);}else{var _19=_3.hitch(this,this.handleLayerInfoForAdvancedFieldsLoaded,_17.url);VIEWER_UTILS.getLayerInfoFromService(_17.url,_16,_19);}}else{this.identifyOptionsWidget.clearFields();}},handleSelectedServiceChanged:function(_1a){if(_1a==null){if(this.identifyOptionsWidget){this.identifyOptionsWidget.clearFields();}return;}var _1b=this.viewModel.currentServiceIsMapService();var _1c=this.viewModel.selectedLayer();if(_1b&&_1c!=null){this.handleSelectedLayerChanged(_1c);}if(!_1b){if(_1a.fields!=null&&_3.isArray(_1a.fields)){this.identifyOptionsWidget.setFields(_1a.fields);}else{this.identifyOptionsWidget.clearFields();}}},handleLayerInfoForAdvancedFieldsLoaded:function(_1d,_1e){if(_1e&&_1e.fields!=null&&_3.isArray(_1e.fields)){this.identifyOptionsWidget.setFields(_1e.fields);if(this.serviceToLayerFieldsCache[_1d]==null){this.serviceToLayerFieldsCache[_1d]={};}this.serviceToLayerFieldsCache[_1d][_1e.id]=_1e.fields;}else{this.identifyOptionsWidget.clearFields();}},createIdentifyOptionsWidget:function(){if(this.identifyOptionsWidget==null){this.identifyOptionsWidget=new _a();this.identifyOptionsWidget.placeAt(this.identifyDisplayFieldsContainer);}},handleDrawActiveChange:function(_1f){if(_1f){this.handleRectangleDraw();}else{this.clearDraw();}},handleRectangleDraw:function(){this.setDraw(VIEWER_GLOBALS.EVENTS.MAP.TOOLS.DRAW_RECTANGLE);},handleIdentifyResultsVisibilityChanged:function(_20){this._handleContentAnimation(_20,this.identifyResultsContainer);},handleIdentifyQueryVisibilityChanged:function(_21){this._handleContentAnimation(_21,this.identifyQueryContainer);},handleDrawContainerVisibilityChanged:function(_22){if(!_22){this.clearDraw();}},clearDraw:function(){this.inherited(arguments);_5.publish(VIEWER_GLOBALS.EVENTS.DRAW.USER.DRAW_CANCEL);this.viewModel.drawActive(false);},initListeners:function(){_5.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADDED,_3.hitch(this,this.handleLayerAdded));_5.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVED,_3.hitch(this,this.handleLayerRemoved));},handleLayerAdded:function(_23){if(!this._isValidIdentifyLayer(_23)){return;}if(_23 instanceof _f||_23 instanceof _12){if(_23==null||_23.serviceDescription==null||!_3.isObject(_23.serviceDescription)||_23.serviceDescription.capabilities==null||_23.serviceDescription.capabilities==""){return;}if(_23.serviceDescription.capabilities.indexOf("Query")<0){return;}}var _24=VIEWER_UTILS.getLayerUniqueId(_23);if(_24==null||this.viewModel.serviceExists(_24)){return;}var _25=VIEWER_UTILS.getLayerNameFromLayer(_23);this.viewModel.services.push({label:_25,value:_23});},handleLayerRemoved:function(_26){var _27=VIEWER_UTILS.getLayerUniqueId(_26);if(_27!=null&&this.viewModel.serviceExists(_27)){this.viewModel.removeService(_27);}},loadServices:function(){var _28;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.OPERATIONAL.GET,function(_29){_28=_29;});if(_28!=null&&_3.isArray(_28)){var _2a;for(var i=0;i<_28.length;i++){_2a=_28[i];if(!this._isValidIdentifyLayer(_2a)){continue;}if(_2a instanceof _f||_2a instanceof _12){if(_2a==null||_2a.serviceDescription==null||!_3.isObject(_2a.serviceDescription)||_2a.serviceDescription.capabilities==null||_2a.serviceDescription.capabilities==""){continue;}if(_2a.serviceDescription.capabilities.indexOf("Query")<0){continue;}}var _2b=VIEWER_UTILS.getLayerUniqueId(_2a);if(_2b!=null&&!this.viewModel.serviceExists(_2b)){var _2c=VIEWER_UTILS.getLayerNameFromLayer(_2a);this.viewModel.services.push({label:_2c,value:_2a});}}}},_isValidIdentifyLayer:function(_2d){return !(_2d==null||_2d instanceof _e||_2d instanceof _10||_2d instanceof _11);},geometryAdded:function(_2e){var _2f=null;if(this.viewModel.currentServiceIsMapService()){_2f=this.viewModel.selectedLayer();}var _30=new _b({whereClause:"",layer:this.viewModel.selectedService(),layerId:_2f,returnGeometry:true,outFields:["*"],geometry:_2e,callback:this.queryResponseCallback,errback:this.queryErrorCallback});_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.QUERY_LAYER,_30);this.viewModel.drawActive(false);},reset:function(){this.viewModel.drawActive(false);this.identifyResponseContents.clearResults();},showQueryView:function(){this.viewModel.showTabContainer(false);this.viewModel.showQuery();},handleQueryResponse:function(_31){this.identifyResponseContents.clearResults();if(_31&&_31.features!=null&&_3.isArray(_31.features)){var _32;var _33;var _34=_31.features.length>this.maxResults?(this.maxResults+1):_31.features.length;var _35=this.identifyOptionsWidget.getSelectedFields();for(var i=0;i<_34;i++){var _36=[];_32=_31.features[i];for(var key in _32.attributes){if(_35[key]!=null){_33=_32.attributes[key]==null?"":_32.attributes[key].toString();_36.push({name:key,value:_33});}}this.identifyResponseContents.addResult({attributes:_36,geometry:_32.geometry});}}if(this.firstResultSet){this.firstResultSet=false;this.identifyResponseContents.startup();}this.viewModel.showResults();var _37=_31&&_31.features&&_3.isArray(_31.features)&&_31.features.length>0;this.viewModel.showClearResults(_37);},handleClearResults:function(){this.identifyResponseContents.clearResults();},handleQueryError:function(err){_5.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Could not complete query");VIEWER_UTILS.log("Could not complete query. Query Failed.",VIEWER_GLOBALS.LOG_TYPE.ERROR);}});});