//>>built
require({cache:{"url:esriviewer/ui/layers/template/LayersTocWidgetTemplate.html":"<div>\r\n    <div class=\"tocRightClickLbl\">Right click for actions</div>\r\n    <div data-dojo-attach-point=\"tocContainer\" class=\"tocContainer\">\r\n\r\n\r\n    </div>\r\n</div>"}});define("esriviewer/ui/layers/LayersTocWidget",["dojo/_base/declare","dojo/text!./template/LayersTocWidgetTemplate.html","dojo/_base/array","dojo/topic","dojo/_base/lang","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dijit/Tree","dijit/tree/ForestStoreModel","dijit/tree/dndSource","dojo/dnd/Avatar","dojo/dnd/Manager","dojo/data/ItemFileWriteStore","./base/LayersTocWidgetContextMenu","../base/UITemplatedWidget","esri/layers/ArcGISTiledMapServiceLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _1([_10],{templateString:_2,constructor:function(){this.treeStore=new _e({data:{items:[],identifier:"id",label:"label"}});this.treeModel=new _a({store:this.treeStore,openOnClick:true});this.tree=new _9({model:this.treeModel,getIconClass:_5.hitch(this,this.getTreeIcon),showRoot:false});_6.set(this.tree.domNode,"height","100%");this.treeContextMenu=new _f({tree:this.tree});this.treeContextMenu.bindNodeToNoContentMenu(this.tree.rootNode.domNode);},postCreate:function(){this.inherited(arguments);_8.place(this.tree.domNode,this.tocContainer);},initListeners:function(){this.tree.on("click",_5.hitch(this,this.treeClickHandler));},getNodeFromItem:function(_12){var _13=_12.id[0];return this.tree._itemNodesMap[_13][0];},getTreeIcon:function(_14,_15){if(_14.root){return "tocIcons layerService";}var _16=null;var _17=null;if(_14.layer){_16=this.treeStore.getValue(_14,"layer");}if(_14.layerId){_17=this.treeStore.getValue(_14,"layerId");}if(_16){if(_17!=null){var _18=this.treeStore.getValue(_14,"info");if(_5.isArray(_18.subLayerIds)&&_18.subLayerIds.length>0){if(_15){return "tocIcons folderOpen";}else{return "tocIcons folderClosed";}}else{var _19=_3.indexOf(_16.visibleLayers,_17)>-1;if(_5.isObject(_18.metadata)){var _1a=_18.metadata;if(_1a.geometryType!=""){if(_1a.geometryType==VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.POINT){if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.TILED_MAP_SERVICE){return "tocIcons layerPoint";}if(_19){return "tocIcons layerPointChecked";}else{return "tocIcons layerPointUnchecked";}}else{if(_1a.geometryType==VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.LINE){if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.TILED_MAP_SERVICE){return "tocIcons layerLine";}if(_19){return "tocIcons layerLineChecked";}else{return "tocIcons layerLineUnchecked";}}else{if(_1a.geometryType==VIEWER_GLOBALS.ESRI_GEOMETRY_TYPES.POLYGON){if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.TILED_MAP_SERVICE){return "tocIcons layerPolygon";}if(_19){return "tocIcons layerPolygonChecked";}else{return "tocIcons layerPolygonUnchecked";}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.TILED_MAP_SERVICE){return "tocIcons layerGeneric";}if(_19){return "layerGenericChecked";}else{return "layerGenericUnchecked";}}}}}else{if(_1a.type==VIEWER_GLOBALS.ESRI_LAYER_TYPES.RASTER){if(_16 instanceof _11){return "tocIcons layerRasterIcon";}if(_19){return "tocIcons layerRasterIconChecked";}else{return "tocIcons layerRasterIconUnchecked";}}else{return _19?"tocIcons layerGenericChecked":"tocIcons layerGenericUnchecked";}}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.IMAGE_SERVICE){return "genericLayerIcon";}else{return _19?"tocIcons layerGenericChecked":"tocIcons layerGenericUnchecked";}}}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.IMAGE_SERVICE){if(_16.visible){return "tocIcons imageServiceChecked";}else{return "tocIcons imageServiceUnchecked";}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.DYNAMIC_MAP_SERVICE){if(_16.visible){return "tocIcons globeChecked";}else{return "tocIcons globeUnchecked";}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.TILED_MAP_SERVICE){if(_16.visible){return "tocIcons layerRasterChecked";}else{return "tocIcons layerRasterUnchecked";}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.FEATURE_LAYER){if(_16.visible){return "tocIcons layerGenericChecked";}else{return "tocIcons layerGenericUnchecked";}}else{if(_16.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.GRAPHICS_LAYER){if(_16.visible){return "tocIcons graphicsLayerChecked";}else{return "tocIcons graphicsLayerUnchecked";}}else{if(_16.visible){return "tocIcons layerGenericChecked";}else{return "tocIcons layerGenericUnchecked";}}}}}}}}return "tocIcons layerGeneric";},addTreeNode:function(_1b,_1c){var _1d={children:[]};_1d.parent=_1c;if(_1c.children!=null){_1d.attribute="children";}return this.treeStore.newItem(_1b,_1d);},addLayer:function(_1e){if(_1e==null||!_1e.isOperationalLayer){return;}var _1f=VIEWER_UTILS.getLayerNameFromLayer(_1e);var _20={label:_1f,serviceId:_1e.id,layer:_1e,id:VIEWER_UTILS.generateUUID()};if(_5.isArray(_1e.layerInfos)&&_1e.layerInfos.length>0){_20.children=[];}var _21=this.addTreeNode(_20,this.tree.rootNode);var _22=this.getNodeFromItem(_21);if(!(_1e.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.GRAPHICS_LAYER)||(_1e.declaredClass==VIEWER_GLOBALS.ESRI_LAYER_DECLARED_CLASSES.FEATURE_LAYER)){this.treeContextMenu.bindNodeToServerMenu(_22.domNode);}else{this.treeContextMenu.bindNodeToGraphicsLayerMenu(_22.domNode);}this.checkForChildLayers(_1e,_21);},checkForChildLayers:function(_23,_24){var _25={};var _26=_23.layerInfos;if(_5.isArray(_26)){var _27=_24;var _28;for(var i=0;i<_26.length;i++){_28=false;var _29=_26[i];if(_29==null){continue;}var _2a=_29.name;subLayerItem={id:VIEWER_UTILS.generateUUID(),label:_2a,layerId:_29.id,serviceId:_23.id,layer:_23,info:_29};if(_5.isArray(_29.subLayerIds)){subLayerItem.children=[];_28=true;}if(_29.parentLayerId>-1){_27=_25[_29.parentLayerId];if(_27==null){return;}}var _2b=this.addTreeNode(subLayerItem,_27);var _2c=this.getNodeFromItem(_2b);if(_28){_25[_29.id]=_2b;this.treeContextMenu.bindNodeToGroupMenu(_2c.domNode);}else{this.treeContextMenu.bindNodeToLayerMenu(_2c.domNode);}}}},removeLayer:function(_2d){if(_2d==null){return;}var _2e;this.treeStore.fetch({query:{serviceId:_2d.id},queryOptions:{deep:false},onComplete:_5.hitch(this,this.deleteNodes)});},deleteNodes:function(_2f){for(var i=0;i<_2f.length;i++){this.deleteNode(_2f[i]);}},deleteChildNodes:function(_30){var _31=this.treeStore.getValue(_30,"isPersistedToCookie");if(_31){var url=this.treeStore.getValue(_30,"url");}var _32=this.getNodeFromItem(_30);var _33=_32.getChildren();for(var i=0;i<_33.length;i++){this.deleteNode(_33[i].item);}this.treeStore.save();},deleteNode:function(_34){this.deleteChildNodes(_34);this.treeStore.deleteItem(_34);this.treeStore.save();},treeClickHandler:function(_35,_36,_37){var _38=null;var _39=null;if(_35.layer){_38=this.treeStore.getValue(_35,"layer");}if(_35.layerId){_39=this.treeStore.getValue(_35,"layerId");}if(_38 instanceof _11&&_35.layerId!=null){return;}if(_38&&_39==null){if(_38.visible){_38.hide();}else{_38.show();}}else{if(_38&&_39!=null){this.toggleDynamicSubLayerItem(_38,_39);this.processVisibleLayers(_38);}}_36._updateItemClasses(_35);},processVisibleLayers:function(_3a){if(_3a.visibleLayers.length==0){_3a.setVisibleLayers([-1]);}else{var _3b=VIEWER_UTILS.sortIntegerArray(_3a.visibleLayers);_3a.setVisibleLayers(_3b);}},toggleDynamicSubLayerItem:function(_3c,_3d){if(_3c==null){return;}var _3e=_3.indexOf(_3c.visibleLayers,_3d)>-1;if(_3e){index=_3.indexOf(_3c.visibleLayers,_3d);if(index>-1){_3c.visibleLayers.splice(index,1);}}else{_3c.visibleLayers.push(_3d);}}});});