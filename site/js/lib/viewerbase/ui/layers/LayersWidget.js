//>>built
require({cache:{"url:esriviewer/ui/layers/template/LayersWidgetTemplate.html":"<div>\r\n    <div class=\"defaultTabContainer\" data-dojo-attach-point=\"layersTabContainer\">\r\n        <span data-dojo-attach-point=\"layersTab\"\r\n              data-bind=\"click:showLayersList, css: {selectedTab: layersListVisible}\">Layers</span>\r\n        <span data-dojo-attach-point=\"addLayersTab\"\r\n              data-bind=\"click:showAddLayers, css: {selectedTab: addlayersVisible}\">Add Layer</span>\r\n        <span data-dojo-attach-point=\"persistsedLayersTab\"\r\n              data-bind=\"click:showUserPersistedLayers, css: {selectedTab: persistedLayersVisible}\">Saved Layers</span>\r\n    </div>\r\n    <div data-bind=\"visible:addlayersVisible\" class=\"addLayerContainer\" data-dojo-attach-point=\"addLayerContainer\">\r\n        <div class=\"addLayerContainerInner\">\r\n            <div class=\"viewerAddLayerWorkingWKIDContainer\" data-bind=\"visible:showWKIDInAddLayers\">\r\n                <span class=\"viewerAddLayerLabel \">Map WKID:</span>\r\n                <span class=\"viewerAddLayerWorkingWKIDLabel\" data-bind=\"text: viewerWKID\"></span>\r\n            </div>\r\n            <div class=\"viewerAddLayerLabel viewerAddLayerUrlLabel \">URL:</div>\r\n            <div data-dojo-type=\"dijit/form/TextBox\" style=\"width: 100%\" data-dojo-attach-point=\"addLayerTextInput\"\r\n                 data-dojo-attach-event=\"onKeyUp:handleLayerAddUrlKeyUp\"></div>\r\n            <div class=\"viewerAddLayerLabel viewerAddLayerUrlLabel \">Label:</div>\r\n            <div data-dojo-type=\"dijit/form/TextBox\" style=\"width: 100%\" data-dojo-attach-point=\"addLayerLabelInput\"\r\n                 value=\"Added Layer\"></div>\r\n            <div class=\"viewerAddLayerActions\">\r\n                <div class=\"layerTypeContainer\">\r\n                    <div class=\"viewerAddLayerLabel\">Type:</div>\r\n                    <select data-dojo-type=\"dijit/form/Select\" style=\"width: 100%\"\r\n                            data-dojo-attach-point=\"addLayerTypeSelect\"\r\n                            style=\"width: 15em\"></select>\r\n                </div>\r\n                <div class=\"viewerAddLayerButtonActions\">\r\n                    <div data-dojo-type=\"dijit/form/Button\" data-dojo-attach-event=\"onClick:addManualLayer\">Add Layer\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n    <div data-dojo-attach-point=\"layerTocContainer\" data-bind=\"visible:layersListVisible\">\r\n\r\n    </div>\r\n    <div data-bind=\"visible:persistedLayersVisible\" data-dojo-attach-point=\"userPersistedLayersContainer\">\r\n    </div>\r\n</div>"}});define("esriviewer/ui/layers/LayersWidget",["dojo/_base/declare","dojo/text!./template/LayersWidgetTemplate.html","dojo/topic","dojo/_base/connect","dojo/_base/lang","dojo/on","dojo/dom-style","dojo/dom-class","dojo/dom-construct","../base/UITemplatedWidget","../tooltip/ConfirmTooltip","./base/LayersLocalStorageMixin","./model/LayersWidgetViewModel","./LayersTocWidget","./base/UserPersistedLayersListWidget","dijit/form/TextBox","dijit/form/Select","dijit/form/Button"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _1([_9,_b],{firstAddLayerDisplay:true,errorMessageDelay:5000,successMessageDelay:2000,allowAddLayers:true,templateString:_2,constructor:function(_12){_5.mixin(this,_12||{});this.addedLayers={};},postCreate:function(){this.inherited(arguments);this.viewModel=new _c();this.viewModel.showUserPersistedLayersIcon(this.localStoragePersistSupported);this.viewModel.layersListVisible.subscribe(_5.hitch(this,this.handleLayerListVisibilityChanged));this.viewModel.addlayersVisible.subscribe(_5.hitch(this,this.handleAddLayersVisibilityChanged));this.viewModel.persistedLayersVisible.subscribe(_5.hitch(this,this.handlePersistedLayersVisibilityChanged));this.viewModel.on(this.viewModel.ADD_LAYERS_VISIBLE,_5.hitch(this,this.handleAddLayersVisible));ko.applyBindings(this.viewModel,this.domNode);this.createLayersTocWidget();_6.set(this.domNode,"minHeight","250px");if(this.allowAddLayers){this.populateLayerTypesDropdown();}else{_6.set(this.layersTabContainer,"display","none");}this.manualLayerLoadedSuccessCallback=_5.hitch(this,this.handleManualLayerLoadedCallback);this.manualLayerLoadedErrCallback=_5.hitch(this,this.handleManualLayerLoadErrorCallback);if(this.localStoragePersistSupported){this.createUserPersistedLayerListWidget();}},handleLayerListVisibilityChanged:function(_13){this._handleContentAnimation(_13,this.layerTocContainer);},handleAddLayersVisibilityChanged:function(_14){this._handleContentAnimation(_14,this.addLayerContainer);},handlePersistedLayersVisibilityChanged:function(_15){this._handleContentAnimation(_15,this.userPersistedLayersContainer);},handleAddLayersVisible:function(){this.addLayerTextInput.set("value","");this.addLayerLabelInput.set("value","");this.addLayerTextInput.focus();},createLayersTocWidget:function(){this.layersTocWidget=new _d();_8.place(this.layersTocWidget.domNode,this.layerTocContainer);},createUserPersistedLayerListWidget:function(){if(this.userPersistedLayersListWidget==null){this.userPersistedLayersListWidget=new _e();this.userPersistedLayersListWidget.placeAt(this.userPersistedLayersContainer);this.userPersistedLayersListWidget.on("removeUserPersistedGraphics",_5.hitch(this,this.handleRemoveUserPersistedLayer));this.userPersistedLayersListWidget.on("addUserPersistedLayerToMap",_5.hitch(this,this.handleAddUserPersistedLayerToMap));this.userPersistedLayersListWidget.on("removeAllUserPersistedGraphics",_5.hitch(this,this.handleRemoveAllUserPersistedLayers));this.userPersistedLayersListWidget.addExistingPersistedLayerItems(this.persistedUserLayers);}},showLayerList:function(){this.viewModel.showLayersList();},handleRemoveAllUserPersistedLayers:function(){this.removeAllLayers();},handleRemoveUserPersistedLayer:function(_16){if(_16!=null&&_16!=""){this.deleteUserPersistedLayer(_16);}},handleAddUserPersistedLayerToMap:function(_17,_18){if(_17!=null&&_17!=""){this._addLayer(_17,_18);}},loadViewerConfigurationData:function(){var _19=null;_3.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"layersWidget",function(_1a){_19=_1a;});if(_19){for(var key in _19){if(key==null||key.toString()==null){continue;}if(key.toString().toLowerCase()=="allowAddLayers".toLowerCase()){this.allowAddLayers=_19[key];}else{if(key.toString().toLowerCase()=="showWKIDInAddLayers".toLowerCase()){if(_19[key]==false){this.viewModel.showWKIDInAddLayers(false);}}}}}},handleManualLayerLoadedCallback:function(){_3.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Layer Added");VIEWER_UTILS.log("Layer Added",VIEWER_GLOBALS.LOG_TYPE.INFO);},handleManualLayerLoadErrorCallback:function(msg){if(msg!=null&&_5.isString(msg)){VIEWER_UTILS.log("Could not add layer: "+msg,VIEWER_GLOBALS.LOG_TYPE.ERROR);}else{VIEWER_UTILS.log("Add Layer Failed",VIEWER_GLOBALS.LOG_TYPE.ERROR);}},initListeners:function(){this.inherited(arguments);_3.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADDED,_5.hitch(this,this.addLayer));_3.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVED,_5.hitch(this,this.handleLayerRemoved));},populateLayerTypesDropdown:function(){var _1b;for(var key in VIEWER_GLOBALS.LAYER_TYPES){_1b=VIEWER_GLOBALS.LAYER_TYPES[key];var _1c={label:_1b.LABEL,value:_1b.VALUE};this.addLayerTypeSelect.addOption(_1c);}},handleAddLayers:function(_1d){if(_1d!=null&&_5.isArray(_1d)){for(var i=0;i<_1d.length;i++){this.addLayer(_1d[i]);}}},addLayer:function(_1e){if(_1e==null){return;}var _1f=VIEWER_UTILS.getLayerUniqueId(_1e);if(_1f==null||this.addedLayers[_1f]!=null){return;}this.layersTocWidget.addLayer(_1e);this.addedLayers[_1f]={layer:_1e};if(_1e.url&&this.localStoragePersistSupported){this.saveLayer(_1e);}},saveLayer:function(_20){var _21=this.persistUserLayer(_20);if(_21&&_21.url){this.userPersistedLayersListWidget.addPersistedLayer(_21);}},handleToggleLayerVisibility:function(_22){if(_22.visible){_22.hide();}else{_22.show();}},handleZoomToLayer:function(_23){_3.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.SET_EXTENT,_23.fullExtent);},handleLayerAddUrlKeyUp:function(e){if(VIEWER_UTILS.isEnterKey(e)){this.addManualLayer();}else{var url=this.addLayerTextInput.get("value");if(url==""){return;}var _24=VIEWER_UTILS.getServiceTypeFromUrl(url);if(_24!=null){if(_24===VIEWER_GLOBALS.SERVICE_TYPES.IMAGE_SERVER){this.addLayerTypeSelect.set("value",VIEWER_GLOBALS.LAYER_TYPES.IMAGE_SERVER.VALUE);}else{if(_24===VIEWER_GLOBALS.SERVICE_TYPES.FEATURE_SERVER){this.addLayerTypeSelect.set("value",VIEWER_GLOBALS.LAYER_TYPES.FEATURE_LAYER.VALUE);}else{if(_24===VIEWER_GLOBALS.SERVICE_TYPES.KML){this.addLayerTypeSelect.set("value",VIEWER_GLOBALS.LAYER_TYPES.KML.VALUE);}else{if(_24===VIEWER_GLOBALS.SERVICE_TYPES.MAP_SERVER){var _25=REG_EXP_UTILS.featureLayerRegExp.test(url);if(_25){this.addLayerTypeSelect.set("value",VIEWER_GLOBALS.LAYER_TYPES.FEATURE_LAYER.VALUE);}else{this.addLayerTypeSelect.set("value",VIEWER_GLOBALS.LAYER_TYPES.MAP_SERVER.VALUE);}}}}}}}},addManualLayer:function(){var url=this.addLayerTextInput.get("value");if(url!=""){if(VIEWER_UTILS.endsWith(url,"/")){url=url.substring(0,url.length-1);}this._addLayer(url);}},_addLayer:function(_26,_27){var _28=_27;if(_28==null||_28==""){_28=this.addLayerLabelInput.get("value");}_3.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_FROM_URL,_26,{isOperationalLayer:true,canRemove:true,label:_28},this.manualLayerLoadedSuccessCallback,this.manualLayerLoadedErrCallback);},showConfirmDeleteLayerTooltip:function(_29,_2a){this.deleteLayerConfirmedCallback=_5.hitch(this,this.handleRemoveLayerFromClick,_29);this.showDeleteLayerTooltip(_2a);},handleRemoveLayerFromClick:function(_2b){_3.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE,_2b);},createConfirmDeleteLayerTooltip:function(){this.confirmDeleteLayerTooltip=new _a({confirmCallback:_5.hitch(this,this.handleConfirmedLayerDelete)});this.confirmDeleteLayerTooltip.on("hide",_5.hitch(this,function(){this.deleteLayerConfirmedCallback=null;}));},handleConfirmedLayerDelete:function(){if(_5.isFunction(this.deleteLayerConfirmedCallback)){this.deleteLayerConfirmedCallback();}this.deleteLayerConfirmedCallback=null;},showDeleteLayerTooltip:function(_2c){if(_2c==null){return;}if(this.confirmDeleteLayerTooltip==null){this.createConfirmDeleteLayerTooltip();}if(this.confirmDeleteLayerTooltip){this.confirmDeleteLayerTooltip.setAroundNode(_2c);this.confirmDeleteLayerTooltip.show();}},handleLayerRemoved:function(_2d){if(_2d==null){return;}var _2e=VIEWER_UTILS.getLayerUniqueId(_2d);if(_2e==null){return;}if(this.addedLayers[_2e]!=null){this.layersTocWidget.removeLayer(_2d);delete this.addedLayers[_2e];}},hidePopups:function(){if(this.confirmDeleteLayerTooltip){this.confirmDeleteLayerTooltip.hide();}}});});