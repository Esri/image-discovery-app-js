//>>built
define("esriviewer/map/geometry/GeometryServiceController",["dojo/_base/declare","dojo/topic","dojo/_base/lang","esri/tasks/GeometryService","esri/config","esri/tasks/AreasAndLengthsParameters","esri/tasks/LengthsParameters","esri/tasks/BufferParameters","esri/tasks/ProjectParameters","esri/geometry/webMercatorUtils","esri/SpatialReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([],{constructor:function(_c){_3.mixin(this,_c||{});this.init();},init:function(){this.loadViewerConfigurationData();if(this.geometryService==null){return;}else{this.initListeners();}var _d=null;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.GET_EXTENT,function(_e){_d=_e;});if(_d&&_d.spatialReference&&_d.spatialReference!=null){this.mapSpatialReference=_d.spatialReference;}this.createMapConfigGeometryService();},loadViewerConfigurationData:function(){var _f=null;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryServiceUrl",function(_10){_f=_10;});this.geometryServiceUrl=_f;if(this.geometryServiceUrl!=null&&this.geometryServiceUrl!=""){this.geometryService=new _4(this.geometryServiceUrl);}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"No Geometry Service in configuration. Service disabled");VIEWER_UTILS.log("No Geometry Service in configuration. Service disabled",VIEWER_GLOBALS.LOG_TYPE.WARNING);}},createMapConfigGeometryService:function(){if(this.geometryServiceUrl){if(_5&&_5.defaults){_5.defaults.geometryService=new _4(this.geometryServiceUrl);}}},initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_LAT_LON,_3.hitch(this,this.handleProjectGeometriesToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.MGRS_TO_LAT_LON,_3.hitch(this,this.handleMgrsToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_MAP_SR,_3.hitch(this,this.handleProjectGeometriesToMapSR));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_AREA,_3.hitch(this,this.handleCalculateArea));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_DISTANCE,_3.hitch(this,this.handleCalculateDistance));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.EXISTS,_3.hitch(this,this.handleGeometryServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.BUFFER_POINT,_3.hitch(this,this.handleBufferPoint));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.BUFFER,_3.hitch(this,this.handleBuffer));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.GET,_3.hitch(this,this.handleGetGeometryService));this.projectErrorDefaultCallback=_3.hitch(this,this.handleProjectionError);},handleGetGeometryService:function(_11){if(_11&&_3.isFunction(_11)){_11(this.geometryService);}},handleCalculateArea:function(_12,_13,_14){if(_14!=null&&_3.isFunction(_14)){var _15=new _6();_15.areaUnit=_13;_15.polygons=[_12];this.geometryService.areasAndLengths(_15,_14,_14);}},handleCalculateDistance:function(_16,_17,_18){if(_18!=null&&_3.isFunction(_18)){var _19=new _7();_19.lengthUnit=_17;_19.polylines=[_16];_19.geodesic=true;this.geometryService.lengths(_19,_18,_18);}},handleMgrsToLatLon:function(_1a,_1b){PROJECTION_UTILS.USNGtoLL(_1a,_1b);},handleBuffer:function(_1c,_1d,_1e){this.geometryService.buffer(_1c,_1d,_1e);},handleBufferPoint:function(pt,_1f,_20,_21){if(pt==null||_1f==null||_1f.distance==null||_1f.units==null){return;}if(_20==null||!_3.isFunction(_20)||this.mapSpatialReference==null){return;}var _22=new _8();if(!_3.isArray(pt)){_22.geometries=[pt];}else{_22.geometries=pt;}_22.distances=[_1f.distance];_22.unit=_1f.units;_22.bufferSpatialReference=pt.spatialReference;_22.outSpatialReference=this.mapSpatialReference;this.geometryService.buffer(_22,_20,_21);},handleProjectGeometriesToLatLon:function(_23,_24){if(_24==null||!_3.isFunction(_24)||_23==null){return;}if(!_3.isArray(_23)){_23=[_23];}if(_23.length==0){_24([]);}var _25=false;var _26=[];if(_23[0].spatialReference.wkid===PROJECTION_UTILS.WEB_MERCATOR_WKID||_23[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){if(_23[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){_24(_23);}var _27=_a.webMercatorToGeographic;if(_3.isFunction(_27)){for(var i=0;i<_23.length;i++){_26.push(_27(_23[i]));}}}if(_26.length>0){_24(_26);}else{var _28=new _9();_28.geometries=_23;_28.outSR=new _b({wkid:PROJECTION_UTILS.WGS_84_WKID});this.geometryService.project(_28,_24,_24);}},handleProjectGeometriesToMapSR:function(_29,_2a,_2b,_2c){if(_29==null){if(_2c&&_3.isFunction(_2c)){_2c("No geometries to project");}return;}if(_2a==null||!_3.isFunction(_2a)||this.mapSpatialReference==null){if(_2c&&_3.isFunction(_2c)){_2c("Cannot process project");}return;}if(!_3.isArray(_29)){_29=[_29];}if(_29.length<0){_2a([]);}var _2d=PROJECTION_UTILS.geometryToMapSpatialReference(_29);if(_2d!=null&&_3.isArray(_2d)){_2a(_2d);}else{this._handleServerSideProject(_29,_2a,_2b,_2c);}},_handleServerSideProject:function(_2e,_2f,_30,_31){if(_30==null){_30={};}var _32=new _9();_32.geometries=_2e;_32.outSR=this.mapSpatialReference;if(_30.transformation){_32.transformation=_30.transformation;}if(_31==null||!_3.isFunction(_31)){_31=this.projectErrorDefaultCallback;}this.geometryService.project(_32,_2f,_31);},handleProjectionError:function(err){VIEWER_UTILS.log("Error Projecting data",VIEWER_GLOBALS.LOG_TYPE.ERROR);},handleGeometryServiceExists:function(_33){if(_33!=null&&_3.isFunction(_33)){_33(this.geometryService!=null);}}});});