//>>built
define("esriviewer/map/geometry/GeometryServiceController",["dojo/_base/declare","dojo/topic","dojo/_base/lang","esri/tasks/GeometryService","esri/config","esri/tasks/AreasAndLengthsParameters","esri/tasks/LengthsParameters","esri/tasks/BufferParameters","esri/tasks/ProjectParameters","esri/geometry/webMercatorUtils","esri/SpatialReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([],{constructor:function(_c){_3.mixin(this,_c||{});this.init();},init:function(){this.loadViewerConfigurationData();if(this.geometryService==null){return;}else{this.initListeners();}var _d=null;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.GET_EXTENT,function(_e){_d=_e;});if(_d&&_d.spatialReference&&_d.spatialReference!=null){this.mapSpatialReference=_d.spatialReference;}this.createMapConfigGeometryService();},loadViewerConfigurationData:function(){var _f=null;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryServiceUrl",function(_10){_f=_10;});this.geometryServiceUrl=_f;if(this.geometryServiceUrl!=null&&this.geometryServiceUrl!=""){this.geometryService=new _4(this.geometryServiceUrl);}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"No Geometry Service in configuration. Service disabled");VIEWER_UTILS.log("No Geometry Service in configuration. Service disabled",VIEWER_GLOBALS.LOG_TYPE.WARNING);}},createMapConfigGeometryService:function(){if(this.geometryServiceUrl){if(_5&&_5.defaults){_5.defaults.geometryService=new _4(this.geometryServiceUrl);}}},initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_LAT_LON,_3.hitch(this,this.handleProjectGeometriesToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.MGRS_TO_LAT_LON,_3.hitch(this,this.handleMgrsToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_MAP_SR,_3.hitch(this,this.handleProjectGeometriesToMapSR));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_AREA,_3.hitch(this,this.handleCalculateArea));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_DISTANCE,_3.hitch(this,this.handleCalculateDistance));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.EXISTS,_3.hitch(this,this.handleGeometryServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.BUFFER_POINT,_3.hitch(this,this.handleBufferPoint));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.BUFFER,_3.hitch(this,this.handleBuffer));this.projectErrorDefaultCallback=_3.hitch(this,this.handleProjectionError);},handleCalculateArea:function(_11,_12,_13){if(_13!=null&&_3.isFunction(_13)){var _14=new _6();_14.areaUnit=_12;_14.polygons=[_11];this.geometryService.areasAndLengths(_14,_13,_13);}},handleCalculateDistance:function(_15,_16,_17){if(_17!=null&&_3.isFunction(_17)){var _18=new _7();_18.lengthUnit=_16;_18.polylines=[_15];_18.geodesic=true;this.geometryService.lengths(_18,_17,_17);}},handleMgrsToLatLon:function(_19,_1a){PROJECTION_UTILS.USNGtoLL(_19,_1a);},handleBuffer:function(_1b,_1c,_1d){this.geometryService.buffer(_1b,_1c,_1d);},handleBufferPoint:function(pt,_1e,_1f,_20){if(pt==null||_1e==null||_1e.distance==null||_1e.units==null){return;}if(_1f==null||!_3.isFunction(_1f)||this.mapSpatialReference==null){return;}var _21=new _8();if(!_3.isArray(pt)){_21.geometries=[pt];}else{_21.geometries=pt;}_21.distances=[_1e.distance];_21.unit=_1e.units;_21.bufferSpatialReference=pt.spatialReference;_21.outSpatialReference=this.mapSpatialReference;this.geometryService.buffer(_21,_1f,_20);},handleProjectGeometriesToLatLon:function(_22,_23){if(_23==null||!_3.isFunction(_23)||_22==null){return;}if(!_3.isArray(_22)){_22=[_22];}if(_22.length==0){_23([]);}var _24=false;var _25=[];if(_22[0].spatialReference.wkid===PROJECTION_UTILS.WEB_MERCATOR_WKID||_22[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){if(_22[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){_23(_22);}var _26=_a.webMercatorToGeographic;if(_3.isFunction(_26)){for(var i=0;i<_22.length;i++){_25.push(_26(_22[i]));}}}if(_25.length>0){_23(_25);}else{var _27=new _9();_27.geometries=_22;_27.outSR=new _b({wkid:PROJECTION_UTILS.WGS_84_WKID});this.geometryService.project(_27,_23,_23);}},handleProjectGeometriesToMapSR:function(_28,_29,_2a,_2b){if(_28==null){if(_2b&&_3.isFunction(_2b)){_2b("No geometries to project");}return;}if(_29==null||!_3.isFunction(_29)||this.mapSpatialReference==null){if(_2b&&_3.isFunction(_2b)){_2b("Cannot process project");}return;}if(!_3.isArray(_28)){_28=[_28];}if(_28.length<0){_29([]);}var _2c=PROJECTION_UTILS.geometryToMapSpatialReference(_28);if(_2c!=null&&_3.isArray(_2c)){_29(_2c);}else{this._handleServerSideProject(_28,_29,_2a,_2b);}},_handleServerSideProject:function(_2d,_2e,_2f,_30){if(_2f==null){_2f={};}var _31=new _9();_31.geometries=_2d;_31.outSR=this.mapSpatialReference;if(_2f.transformation){_31.transformation=_2f.transformation;}if(_30==null||!_3.isFunction(_30)){_30=this.projectErrorDefaultCallback;}this.geometryService.project(_31,_2e,_30);},handleProjectionError:function(err){VIEWER_UTILS.log("Error Projecting data",VIEWER_GLOBALS.LOG_TYPE.ERROR);},handleGeometryServiceExists:function(_32){if(_32!=null&&_3.isFunction(_32)){_32(this.geometryService!=null);}}});});