//>>built
define("esriviewer/map/geometry/GeometryServiceController",["dojo/_base/declare","dojo/topic","dojo/_base/lang","esri/tasks/GeometryService","esri/config","esri/tasks/AreasAndLengthsParameters","esri/tasks/LengthsParameters","esri/tasks/BufferParameters","esri/tasks/ProjectParameters","esri/geometry/webMercatorUtils","esri/SpatialReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([],{constructor:function(_c){_3.mixin(this,_c||{});this.init();},init:function(){this.loadViewerConfigurationData();if(this.geometryService==null){return;}else{this.initListeners();}var _d=null;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.GET_EXTENT,function(_e){_d=_e;});if(_d&&_d.spatialReference&&_d.spatialReference!=null){this.mapSpatialReference=_d.spatialReference;}this.createMapConfigGeometryService();},loadViewerConfigurationData:function(){var _f=null;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryServiceUrl",function(_10){_f=_10;});this.geometryServiceUrl=_f;if(this.geometryServiceUrl!=null&&this.geometryServiceUrl!=""){this.geometryService=new _4(this.geometryServiceUrl);}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"No Geometry Service in configuration. Service disabled");VIEWER_UTILS.log("No Geometry Service in configuration. Service disabled",VIEWER_GLOBALS.LOG_TYPE.WARNING);}},createMapConfigGeometryService:function(){if(this.geometryServiceUrl){if(_5&&_5.defaults){_5.defaults.geometryService=new _4(this.geometryServiceUrl);}}},initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_LAT_LON,_3.hitch(this,this.handleProjectGeometriesToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.MGRS_TO_LAT_LON,_3.hitch(this,this.handleMgrsToLatLon));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.PROJECT_TO_MAP_SR,_3.hitch(this,this.handleProjectGeometriesToMapSR));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_AREA,_3.hitch(this,this.handleCalculateArea));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.TASKS.CALCULATE_DISTANCE,_3.hitch(this,this.handleCalculateDistance));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.EXISTS,_3.hitch(this,this.handleGeometryServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.BUFFER_POINT,_3.hitch(this,this.handleBufferPoint));this.projectErrorDefaultCallback=_3.hitch(this,this.handleProjectionError);},handleCalculateArea:function(_11,_12,_13){if(_13!=null&&_3.isFunction(_13)){var _14=new _6();_14.areaUnit=_12;_14.polygons=[_11];this.geometryService.areasAndLengths(_14,_13,_13);}},handleCalculateDistance:function(_15,_16,_17){if(_17!=null&&_3.isFunction(_17)){var _18=new _7();_18.lengthUnit=_16;_18.polylines=[_15];_18.geodesic=true;this.geometryService.lengths(_18,_17,_17);}},handleMgrsToLatLon:function(_19,_1a){PROJECTION_UTILS.USNGtoLL(_19,_1a);},handleBufferPoint:function(pt,_1b,_1c,_1d){if(pt==null||_1b==null||_1b.distance==null||_1b.units==null){return;}if(_1c==null||!_3.isFunction(_1c)||this.mapSpatialReference==null){return;}var _1e=new _8();_1e.geometries=[pt];_1e.distances=[_1b.distance];_1e.unit=_1b.units;_1e.bufferSpatialReference=pt.spatialReference;_1e.outSpatialReference=this.mapSpatialReference;this.geometryService.buffer(_1e,_1c,_1d);},handleProjectGeometriesToLatLon:function(_1f,_20){if(_20==null||!_3.isFunction(_20)||_1f==null){return;}if(!_3.isArray(_1f)){_1f=[_1f];}if(_1f.length==0){_20([]);}var _21=false;var _22=[];if(_1f[0].spatialReference.wkid===PROJECTION_UTILS.WEB_MERCATOR_WKID||_1f[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){if(_1f[0].spatialReference.wkid===PROJECTION_UTILS.WGS_84_WKID){_20(_1f);}var _23=_a.webMercatorToGeographic;if(_3.isFunction(_23)){for(var i=0;i<_1f.length;i++){_22.push(_23(_1f[i]));}}}if(_22.length>0){_20(_22);}else{var _24=new _9();_24.geometries=_1f;_24.outSR=new _b({wkid:PROJECTION_UTILS.WGS_84_WKID});this.geometryService.project(_24,_20,_20);}},handleProjectGeometriesToMapSR:function(_25,_26,_27,_28){if(_25==null){if(_28&&_3.isFunction(_28)){_28("No geometries to project");}return;}if(_26==null||!_3.isFunction(_26)||this.mapSpatialReference==null){if(_28&&_3.isFunction(_28)){_28("Cannot process project");}return;}if(!_3.isArray(_25)){_25=[_25];}if(_25.length<0){_26([]);}var _29=PROJECTION_UTILS.geometryToMapSpatialReference(_25);if(_29!=null&&_3.isArray(_29)){_26(_29);}else{this._handleServerSideProject(_25,_26,_27,_28);}},_handleServerSideProject:function(_2a,_2b,_2c,_2d){if(_2c==null){_2c={};}var _2e=new _9();_2e.geometries=_2a;_2e.outSR=this.mapSpatialReference;if(_2c.transformation){_2e.transformation=_2c.transformation;}if(_2d==null||!_3.isFunction(_2d)){_2d=this.projectErrorDefaultCallback;}this.geometryService.project(_2e,_2b,_2d);},handleProjectionError:function(err){VIEWER_UTILS.log("Error Projecting data",VIEWER_GLOBALS.LOG_TYPE.ERROR);},handleGeometryServiceExists:function(_2f){if(_2f!=null&&_3.isFunction(_2f)){_2f(this.geometryService!=null);}}});});