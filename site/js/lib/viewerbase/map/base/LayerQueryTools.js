//>>built
define("esriviewer/map/base/LayerQueryTools",["dojo/_base/declare","dojo/_base/lang","dojo/topic","esri/tasks/QueryTask","esri/tasks/query"],function(_1,_2,_3,_4,_5){return _1([],{constructor:function(){this.layerFieldsCache={};this.initListeners();},initListeners:function(){this.inherited(arguments);_3.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.QUERY_LAYER,_2.hitch(this,this.handleQueryLayer));},handleQueryLayer:function(_6){if(_6.layer==null||_6.layer.url==null){if(_6.errback!=null&&_2.isFunction(_6.errback)){_6.errback("There is no query layer");}return;}if(_6.callback==null||!_2.isFunction(_6.callback)){return;}if(_6.errback==null){_2.hitch(this,this.handleQueryLayerDefaultErrback,_6.layer);}var _7=_6.layer.url;if(_6.layerId!=null){_7=VIEWER_UTILS.joinUrl(_7,_6.layerId);}var _8=new _4(_7);var _9=new _5();_9.returnGeometry=_6.returnGeometry;if(_6.whereClause!=null&&_6.whereClause.length>0){_9.where=_6.whereClause;}if(_6.geometry!=null){_9.geometry=_6.geometry;}if(_6.outFields!=null){_9.outFields=_6.outFields;}else{if(_6.returnGeometry){_9.outFields=["*"];}else{var _a=_7.toLowerCase();if(this.layerFieldsCache[_a]==null){if(_6.layerId!=null){var _b=_6.callback;var _c=_6.errback;VIEWER_UTILS.getLayerInfoFromService(_6.layer.url,_6.layerId,_2.hitch(this,function(_d){var _e=this._generateOutFieldsFromLayer(_d);this.layerFieldsCache[_a]=_e;_9.outFields=_e;this._performQuery(_8,_9,_b,_c);}));return;}else{var _f=this._generateOutFieldsFromLayer(_6.layer);this.layerFieldsCache[_a]=_f;_9.outFields=_f;}}else{_9.outFields=this.layerFieldsCache[_a];}}}this._performQuery(_8,_9,_6.callback,_6.errback);},_generateOutFieldsFromLayer:function(_10){if(_10==null||!_2.isObject(_10)||_10.fields==null||!_2.isArray(_10.fields)){return ["*"];}var _11=[];var _12;for(var i=0;i<_10.fields.length;i++){_12=_10.fields[i];if(_12.type!=VIEWER_GLOBALS.ESRI_FIELD_TYPES.GEOMETRY){_11.push(_12.name);}}return _11;},_performQuery:function(_13,_14,_15,_16){_13.execute(_14,_15,_16);},handleQueryLayerDefaultErrback:function(_17,err){VIEWER_UTILS.log("Could not perform layer query",VIEWER_GLOBALS.LOG_TYPE.ERROR);_3.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Could not perform layer query");}});});