//>>built
define("esriviewer/map/base/MapLayersTools",["dojo/_base/declare","dojo/topic","dojo/_base/lang","dojo/dom-construct","esri/layers/OpenStreetMapLayer","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/KMLLayer","esri/layers/WMSLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([],{labelServicesVisible:false,constructor:function(_d){_3.mixin(this,_d);this.loadViewerConfigurationData();this.currrentBasemapKey=null;this.labelServices={};this.timeEnabledLayers=[];this.operationalLayers={};this.graphicsLayers={};this._initListeners();},loadViewerConfigurationData:function(){if(this.mapConfiguration==null){var _e;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_f){_e=_f;});if(_e){this.mapConfiguration=_e;}}},_initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVE,_3.hitch(this,this.handleRemoveBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_GRAPHICS_LAYER,_3.hitch(this,this.handleAddGraphicsLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADD,_3.hitch(this,this.handleAddBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.SET,_3.hitch(this,this.changeBaseMaps));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT_URL,_3.hitch(this,this.handleGetCurrentBasemapUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT,_3.hitch(this,this.handleGetCurrentBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SHOW,_3.hitch(this,this.showLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.HIDE,_3.hitch(this,this.hideLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SERVICE_EXISTS,_3.hitch(this,this.handleLabelServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.TIME.GET_TIME_ENABLED_SERVICES,_3.hitch(this,this.handleGetTimeEnabledLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.OPERATIONAL.GET,_3.hitch(this,this.handleGetOperationalLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_FROM_URL,_3.hitch(this,this.handleAddLayerFromUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD,_3.hitch(this,this.handleAddLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_EXTERNAL_MANAGED_LAYER,_3.hitch(this,this.handleAddExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_EXTERNAL_MANAGED_LAYER,_3.hitch(this,this.handleRemoveExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.GET_FEATURE_LAYER_IF_EXISTS,_3.hitch(this,this.handleGetFeatureLayerIfExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE,_3.hitch(this,this.handleRemoveLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_REFERENCE_LAYER,_3.hitch(this,this.handleAddReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_REFERENCE_LAYER,_3.hitch(this,this.handleRemoveReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MOVE_LAYER_TO_TOP,_3.hitch(this,this.handleMoveLayerToTop));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_VISIBLE,_3.hitch(this,this.handleMakeLayerVisible));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_INVISIBLE,_3.hitch(this,this.handleMakeLayerInvisible));this.map.on("layer-add",_3.hitch(this,this.handleLayerAdded));},handleMakeLayerVisible:function(_10){if(_10!=null){_10.show();}},handleMakeLayerInvisible:function(_11){if(_11!=null){_11.hide();}},handleMoveLayerToTop:function(_12){if(_12){this.map.reorderLayer(_12,this.map.layerIds.length);}},handleLayerAdded:function(evt){if(evt==null||evt.layer==null){return;}var _13=evt.layer;if(_13!=null&&_13.isReferenceLayer==null||!_13.isReferenceLayer){if(_13.timeInfo!=null){this.timeEnabledLayers.push(_13);VIEWER_UTILS.log("Found time enabled layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.TIME.TIME_LAYER_FOUND,_13);}}if(_13.isOperationalLayer!=null&&_13.isOperationalLayer===true){VIEWER_UTILS.log("Added operational layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADDED,_13);}},handleGetFeatureLayerIfExists:function(_14,_15){if(_14==null||_14==""||_15==null||!_3.isFunction(_15)){return;}var _16=_14.toLowerCase();_15(this.operationalLayers[_16]);},handleAddGraphicsLayer:function(_17){if(_17!=null){this.map.addLayer(_17);var _18=VIEWER_UTILS.generateUUID();_17.id=_18;this.graphicsLayers[_18]=_17;}},handleAddBasemap:function(_19,_1a,_1b){var id=_19.toLowerCase();if(this.basemaps[id]!=null){_1b("Basemap Already Exists");}var _1c=_3.hitch(this,this._handleBaseMapServiceDescriptionLoaded,_19,_1a,_1b);VIEWER_UTILS.getServiceDescription(_19,_1c);},_handleBaseMapServiceDescriptionLoaded:function(_1d,_1e,_1f,_20){if(this.isServiceTiledAndInMapSR(_20)){var id=_1d.toLowerCase();var _21={id:id,label:REG_EXP_UTILS.getServiceNameFromUrl(_1d),url:_1d};this.basemaps[id]=_21;VIEWER_UTILS.debug("Added Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADDED,_21,id);if(_1e!=null&&_3.isFunction(_1e)){_1e(_21);}}else{if(_1f!=null&&_3.isFunction(_1f)){_1f("Could not add basemap. Is the service cached and in the map spatial reference ("+this.map.spatialReference.wkid+")?");}}},handleRemoveLayer:function(_22){if(_22==null){return;}if(_22.url!=null){var _23=_22.url.toLowerCase();if(this.operationalLayers[_23]){delete this.operationalLayers[_23];}}if(_22 instanceof _7){if(this.graphicsLayers[_22.id]!=null){delete this.graphicsLayers[_22.id];}}this.map.removeLayer(_22);VIEWER_UTILS.debug("Removed Layer: "+_22.name);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVED,_22);},handleGetOperationalLayers:function(_24){if(_24!=null&&_3.isFunction(_24)){var _25=[];for(var key in this.operationalLayers){_25.push(this.operationalLayers[key]);}_24(_25);}},handleGetTimeEnabledLayers:function(_26){if(_26!=null&&_3.isFunction(_26)){_26(this.timeEnabledLayers);}},handleRemoveExternalManagedLayer:function(_27){this.map.removeLayer(_27);},handleAddExternalManagedLayer:function(_28){this.map.addLayer(_28);},handleAddLayer:function(_29,_2a,_2b,_2c){if(_2a&&_2a.isOperationalLayer!=false){if(_29.url!=null){var _2d=_29.url.toLowerCase();if(this.operationalLayers[_2d]!=null){return;}}this.operationalLayers[_2d]=_29;_29.isOperationalLayer=true;}else{_29.isOperationalLayer=false;}_29.canRemove=_2a!=null&&_2a.canRemove!=false;this.map.addLayer(_29);if(_2b!=null&&_3.isFunction(_2b)){_29.on("load",_2b);}if(_2c!=null&&_3.isFunction(_2c)){var _2e=function(){_2c(_29);};_29.on("error",_3.hitch(this,_2e));}VIEWER_UTILS.debug("Added Layer: "+_29.url);},handleAddLayerFromUrl:function(_2f,_30,_31,_32){var _33=_2f.toLowerCase();if(this.operationalLayers[_33]!=null){if(_32!=null&&_3.isFunction(_32)){_32("Layer has already been added to the map");}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Layer has already been added to the map");}return;}var _34=null;var _35=VIEWER_UTILS.getServiceTypeFromUrl(_2f);if(_35){if(_35==VIEWER_GLOBALS.SERVICE_TYPES.MAP_SERVER){if(REG_EXP_UTILS.isFeatureLayer(_2f)){_34=new _6(_2f,_3.mixin({mode:_6.MODE_ONDEMAND},_30||{}));}else{this._handleAddMapServiceLayer(_2f,_30,_31,_32);return;}}else{if(_35==VIEWER_GLOBALS.SERVICE_TYPES.KML){_34=new _9(_2f);}else{if(_35==VIEWER_GLOBALS.SERVICE_TYPES.IMAGE_SERVER){_34=new _8(_2f);}else{if(_35===VIEWER_GLOBALS.SERVICE_TYPES.FEATURE_SERVER){_34=new _6(_2f,_3.mixin({mode:_6.MODE_ONDEMAND},_30||{}));}}}}}else{if(_2f.indexOf("/wms/")>-1){_34=new _a(_2f,_30);}}if(_34){_34.canRemove=_30!=null&&_30.canRemove!=false;_34.isOperationalLayer=_30!=null&&_30.isOperationalLayer!=null&&_30.isOperationalLayer!=false;_34.layerAliasName=(_30&&_30.label)?_30.label:REG_EXP_UTILS.getServiceNameFromUrl(_2f);if(_31!=null&&_3.isFunction(_31)){_34.on("load",_31);}if(_32!=null&&_3.isFunction(_32)){_34.on("error",_32);}var _36=this.operationalLayers;_34.on("load",function(){_36[_34.url.toLowerCase()]=_34;});VIEWER_UTILS.debug("Added Layer from URL: "+_2f);this.map.addLayer(_34);}else{if(_3.isFunction(_32)){_32("Could Not Add Layer");}}},_handleAddMapServiceLayer:function(_37,_38,_39,_3a){var _3b=_3.hitch(this,_3.hitch(this,this._handleAddMapServiceServiceDescriptionLoaded,_37,_38,_39,_3a));VIEWER_UTILS.getServiceDescription(_37,_3b);},_handleAddMapServiceServiceDescriptionLoaded:function(_3c,_3d,_3e,_3f,_40){var _41;var _42=_3c.toLowerCase();if(_40!=null&&_3.isObject(_40)){if(this.isServiceTiledAndInMapSR(_40)){_41=new _b(_3c);}else{_41=new _c(_3c);}_41.isOperationalLayer=_3d!=null&&_3d.isOperationalLayer!=null&&_3d.isOperationalLayer!=false;var _43=this.operationalLayers;_41.on("load",function(){_43[_41.url.toLowerCase()]=_41;});_41.serviceDescription=_40;}if(_41!=null){_41.name=REG_EXP_UTILS.getServiceNameFromUrl(_3c);if(_3d!=null&&_3d.canRemove!=null){_41.canRemove=true;}if(_3e!=null&&_3.isFunction(_3e)){_41.on("load",_3e);}if(_3f!=null&&_3.isFunction(_3f)){_41.on("error",_3f);}VIEWER_UTILS.debug("Added Layer: "+_41.url);this.map.addLayer(_41);}},isServiceTiledAndInMapSR:function(_44){if(_44!=null&&_3.isObject(_44)){return _44.tileInfo!=null&&_44.spatialReference!=null&&_44.spatialReference.wkid==this.map.spatialReference.wkid;}return false;},handleLabelServiceExists:function(_45){if(_45!=null&&_3.isFunction(_45)){var _46=false;for(var key in this.labelServices){_46=true;break;}_45(_46);}},handleRemoveBasemap:function(id){var _47=this.basemaps[id];if(this.basemaps[id]!=null){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===id){this.map.removeLayer(this.currentBasemap);for(var key in this.basemaps){this.changeBaseMaps(key);break;}}delete this.basemaps[id];VIEWER_UTILS.debug("Removed Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVED,id);}},changeBaseMaps:function(key){var _48=this.basemaps[key];if(_48){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===key){return;}if(this.currentBasemap!=null){this.map.removeLayer(this.currentBasemap);}if(_48.isOpenStreetMap==null||_48.isOpenStreetMap==false){this.currentBasemap=new _b(_48.url);}else{this.currentBasemap=new _5();}this.map.addLayer(this.currentBasemap,0);VIEWER_UTILS.debug("Changed Basemap: "+key);this.currrentBasemapKey=key;}},handleGetCurrentBasemapUrl:function(_49){if(_49!=null&&_3.isFunction(_49)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_49(this.basemaps[this.currrentBasemapKey].url);return;}else{var _4a;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_4b){_4a=_4b;});if(_4a){var _4c=_4a.getSelected();if(_4c==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_3.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_49(this.webMapItem.itemData.baseMap.baseMapLayers[0].url);return;}}else{if(_4c&&_4c.layers&&_3.isArray(_4c.layers)&&_4c.layers.length>0){_49(_4c.layers[0].url);return;}}}}_49(null);}},handleGetCurrentBasemap:function(_4d){if(_4d!=null&&_3.isFunction(_4d)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_4d(this.currrentBasemapKey);return;}else{var _4e;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_4f){_4e=_4f;});if(_4e){var _50=_4e.getSelected();if(_50==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_3.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_4d(new _b(this.webMapItem.itemData.baseMap.baseMapLayers[0].url));return;}}else{_4d(_50);return;}}}}_4d(null);},showLabelServices:function(){var _51;for(var key in this.labelServices){_51=this.labelServices[key];_51.show();this.handleMoveLayerToTop(_51);}VIEWER_UTILS.debug("Displayed Label Services");this.labelServicesVisible=true;},hideLabelServices:function(){for(var key in this.labelServices){this.labelServices[key].hide();}VIEWER_UTILS.debug("Hid Label Services");this.labelServicesVisible=false;},handleAddReferenceLayerRequest:function(_52,_53,_54){if(_52==null||_52.url==null||_52.url==""){if(_54!=null&&_3.isFunction(_54)){_54("Invalid Reference Layer");}}var id=_52.url.toLowerCase();if(this.labelServices[id]!=null){if(_54!=null&&_3.isFunction(_54)){_54("Reference Layer Already Exists");}}var _55=this._addReferenceLayer(_52);if(_55!=null){if(_53!=null&&_3.isFunction(_53)){_53(_55);}}else{if(_54!=null&&_3.isFunction(_54)){_54("Could not add reference layer");}}},addReferenceLayers:function(){if(this.mapConfiguration.referenceLayers!=null&&_3.isArray(this.mapConfiguration.referenceLayers)){var _56;for(var i=0;i<this.mapConfiguration.referenceLayers.length;i++){_56=this.mapConfiguration.referenceLayers[i];this._addReferenceLayer(_56);}}},_addReferenceLayer:function(_57){var _58=this._getMapLayerFromLayerObject(_57);if(_58!=null){if(!this.labelServicesVisible){_58.hide();}else{_58.show();}var id=_58.url.toLowerCase();this.labelServices[id]=_58;_58.isReferenceLayer=true;this.map.addLayer(_58);VIEWER_UTILS.log("Added Reference Layer: "+_58.url,VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_ADDED,_58);return _58;}return null;},handleRemoveReferenceLayerRequest:function(_59){var id=_59.url.toLowerCase();if(this.labelServices[id]!=null){this.map.removeLayer(_59);delete this.labelServices[id];var _5a=false;for(var key in this.labelServices){_5a=true;break;}VIEWER_UTILS.log("Removed reference layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_REMOVED,_59,_5a);}},addWebMapOperationalLayers:function(_5b){var _5c;var _5d;for(var i=0;i<_5b.itemData.operationalLayers.length;i++){_5c=_5b.itemData.operationalLayers[i];_5d=_5c.layerObject;_5d.name=REG_EXP_UTILS.getServiceNameFromUrl(_5d.url);_5d.isOperationalLayer=true;var _5e=_5d.url.toLowerCase();if(this.operationalLayers[_5e]==null){this.operationalLayers[_5e]=_5d;}VIEWER_UTILS.getServiceDescription(_5d.url,_3.hitch(this,function(_5f,_60){_5f.serviceDescription=_60;this.handleLayerAdded(_5f);},_5d));}},addOperationalLayers:function(){if(this.mapConfiguration.operationalLayers!=null&&_3.isArray(this.mapConfiguration.operationalLayers)){var _61;for(var i=0;i<this.mapConfiguration.operationalLayers.length;i++){_61=this.mapConfiguration.operationalLayers[i];var _62=this._getMapLayerFromLayerObject(_61);if(_62!=null){VIEWER_UTILS.getServiceDescription(_61.url,_3.hitch(this,function(_63,_64){_63.serviceDescription=_64;},_62));_62.name=REG_EXP_UTILS.getServiceNameFromUrl(_61.url);if(_61.label!=null&&_61.label!=""){_62.layerAliasName=_61.label;}this.map.addLayer(_62);_62.isOperationalLayer=true;var _65=_62.url.toLowerCase();if(this.operationalLayers[_65]==null){this.operationalLayers[_65]=_62;}}}}},_getMapLayerFromLayerObject:function(_66){if(_66.type==null||_66.type==""||_66.url==null||_66.url==""){return null;}var _67={};if(_66.visible!=null){_67.visible=_66.visible;}var _68=_66.type.toLowerCase();if(_68==="tiled"){return new _b(_66.url,_67);}else{if(_68==="dynamic"){var _69=new _c(_66.url,_67);if(_66.visibleLayerIds!=null&&_3.isArray(_66.visibleLayerIds)){_69.setVisibleLayers(_66.visibleLayerIds);}return _69;}else{if(_68==="image"){return new _8(_66.url,_67);}else{if(_68==="feature"){_67=_3.mixin(_67,{mode:_6.MODE_ONDEMAND,outFields:["*"]});return new _6(_66.url,_67);}else{if(_68==="kml"){return new _9(_66.url);}}}}}}});});