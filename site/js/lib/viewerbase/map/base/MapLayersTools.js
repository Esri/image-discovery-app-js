//>>built
define("esriviewer/map/base/MapLayersTools",["dojo/_base/declare","dojo/topic","dojo/_base/lang","esri/layers/OpenStreetMapLayer","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/KMLLayer","esri/layers/WMSLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([],{labelServicesVisible:false,constructor:function(_c){_3.mixin(this,_c);this.loadViewerConfigurationData();this.currrentBasemapKey=null;this.labelServices={};this.timeEnabledLayers=[];this.operationalLayers={};this.graphicsLayers={};this.initListeners();},loadViewerConfigurationData:function(){if(this.mapConfiguration==null){var _d=null;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_e){_d=_e;});if(_d){this.mapConfiguration=_d;}}},initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVE,_3.hitch(this,this.handleRemoveBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_GRAPHICS_LAYER,_3.hitch(this,this.handleAddGraphicsLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADD,_3.hitch(this,this.handleAddBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.SET,_3.hitch(this,this.changeBaseMaps));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT_URL,_3.hitch(this,this.handleGetCurrentBasemapUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT,_3.hitch(this,this.handleGetCurrentBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SHOW,_3.hitch(this,this.showLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.HIDE,_3.hitch(this,this.hideLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SERVICE_EXISTS,_3.hitch(this,this.handleLabelServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.TIME.GET_TIME_ENABLED_SERVICES,_3.hitch(this,this.handleGetTimeEnabledLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.OPERATIONAL.GET,_3.hitch(this,this.handleGetOperationalLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_FROM_URL,_3.hitch(this,this.handleAddLayerFromUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD,_3.hitch(this,this.handleAddLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_EXTERNAL_MANAGED_LAYER,_3.hitch(this,this.handleAddExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_EXTERNAL_MANAGED_LAYER,_3.hitch(this,this.handleRemoveExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.GET_FEATURE_LAYER_IF_EXISTS,_3.hitch(this,this.handleGetFeatureLayerIfExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE,_3.hitch(this,this.handleRemoveLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_REFERENCE_LAYER,_3.hitch(this,this.handleAddReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_REFERENCE_LAYER,_3.hitch(this,this.handleRemoveReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MOVE_LAYER_TO_TOP,_3.hitch(this,this.handleMoveLayerToTop));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_VISIBLE,_3.hitch(this,this.handleMakeLayerVisible));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_INVISIBLE,_3.hitch(this,this.handleMakeLayerInvisible));this.map.on("layer-add",_3.hitch(this,this._handleLayerAdded));},handleMakeLayerVisible:function(_f){if(_f!=null){_f.show();}},handleMakeLayerInvisible:function(_10){if(_10!=null){_10.hide();}},handleMoveLayerToTop:function(_11){if(_11){this.map.reorderLayer(_11,this.map.layerIds.length);}},_handleLayerAdded:function(evt){if(evt==null||evt.layer==null){return;}var _12=evt.layer;if(_12!=null&&_12.isReferenceLayer==null||!_12.isReferenceLayer){if(_12.timeInfo!=null){this.timeEnabledLayers.push(_12);VIEWER_UTILS.log("Found time enabled layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.TIME.TIME_LAYER_FOUND,_12);}}if(_12.isOperationalLayer!=null&&_12.isOperationalLayer===true){VIEWER_UTILS.log("Added operational layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADDED,_12);}},handleGetFeatureLayerIfExists:function(_13,_14){if(_13==null||_13==""||_14==null||!_3.isFunction(_14)){return;}var _15=_13.toLowerCase();_14(this.operationalLayers[_15]);},handleAddGraphicsLayer:function(_16){if(_16!=null){this.map.addLayer(_16);var _17=VIEWER_UTILS.generateUUID();_16.id=_17;this.graphicsLayers[_17]=_16;}},handleAddBasemap:function(_18,_19,_1a){var id=_18.toLowerCase();if(this.basemaps[id]!=null){_1a("Basemap Already Exists");}var _1b=_3.hitch(this,this._handleBaseMapServiceDescriptionLoaded,_18,_19,_1a);VIEWER_UTILS.getServiceDescription(_18,_1b);},_handleBaseMapServiceDescriptionLoaded:function(_1c,_1d,_1e,_1f){if(this.isServiceTiledAndInMapSR(_1f)){var id=_1c.toLowerCase();var _20={id:id,label:REG_EXP_UTILS.getServiceNameFromUrl(_1c),url:_1c};this.basemaps[id]=_20;VIEWER_UTILS.debug("Added Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADDED,_20,id);if(_1d!=null&&_3.isFunction(_1d)){_1d(_20);}}else{if(_1e!=null&&_3.isFunction(_1e)){_1e("Could not add basemap. Is the service cached and in the map spatial reference ("+this.map.spatialReference.wkid+")?");}}},handleRemoveLayer:function(_21){if(_21==null){return;}var _22=VIEWER_UTILS.getLayerUniqueId(_21);if(_22!=null){if(this.operationalLayers[_22]){delete this.operationalLayers[_22];}}if(_21 instanceof _6){if(this.graphicsLayers[_21.id]!=null){delete this.graphicsLayers[_21.id];}}this.map.removeLayer(_21);VIEWER_UTILS.debug("Removed Layer: "+_21.name);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVED,_21);},handleGetOperationalLayers:function(_23){if(_23!=null&&_3.isFunction(_23)){var _24=[];for(var key in this.operationalLayers){_24.push(this.operationalLayers[key]);}_23(_24);}},handleGetTimeEnabledLayers:function(_25){if(_25!=null&&_3.isFunction(_25)){_25(this.timeEnabledLayers);}},handleRemoveExternalManagedLayer:function(_26){this.map.removeLayer(_26);},handleAddExternalManagedLayer:function(_27){this.map.addLayer(_27);},handleAddLayer:function(_28,_29,_2a,_2b){if(_29&&_29.isOperationalLayer!=false){var _2c=VIEWER_UTILS.getLayerUniqueId(_28);if(_2c!=null){if(this.operationalLayers[_2c]!=null){return;}}this.operationalLayers[_2c]=_28;_28.isOperationalLayer=true;}else{_28.isOperationalLayer=false;}_28.canRemove=_29!=null&&_29.canRemove!=false;this.map.addLayer(_28);if(_2a!=null&&_3.isFunction(_2a)){_28.on("load",_2a);}if(_2b!=null&&_3.isFunction(_2b)){var _2d=function(){_2b(_28);};_28.on("error",_3.hitch(this,_2d));}VIEWER_UTILS.debug("Added Layer: "+_2c);},handleAddLayerFromUrl:function(_2e,_2f,_30,_31){var _32=VIEWER_UTILS.getLayerUniqueId(_2e);if(this.operationalLayers[_32]!=null){if(_31!=null&&_3.isFunction(_31)){_31("Layer has already been added to the map");}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Layer has already been added to the map");}return;}var _33=null;var _34=VIEWER_UTILS.getServiceTypeFromUrl(_2e);if(_34){if(_34==VIEWER_GLOBALS.SERVICE_TYPES.MAP_SERVER){if(REG_EXP_UTILS.isFeatureLayer(_2e)){_33=new _5(_2e,_3.mixin({mode:_5.MODE_ONDEMAND},_2f||{}));}else{this._handleAddMapServiceLayer(_2e,_2f,_30,_31);return;}}else{if(_34==VIEWER_GLOBALS.SERVICE_TYPES.KML){_33=new _8(_2e);}else{if(_34==VIEWER_GLOBALS.SERVICE_TYPES.IMAGE_SERVER){_33=new _7(_2e);}else{if(_34===VIEWER_GLOBALS.SERVICE_TYPES.FEATURE_SERVER){_33=new _5(_2e,_3.mixin({mode:_5.MODE_ONDEMAND},_2f||{}));}}}}}else{if(_2e.indexOf("/wms/")>-1){_33=new _9(_2e,_2f);}}if(_33){_33.canRemove=_2f!=null&&_2f.canRemove!=false;_33.isOperationalLayer=_2f!=null&&_2f.isOperationalLayer!=null&&_2f.isOperationalLayer!=false;_33.layerAliasName=(_2f&&_2f.label)?_2f.label:REG_EXP_UTILS.getServiceNameFromUrl(_2e);if(_30!=null&&_3.isFunction(_30)){_33.on("load",_30);}if(_31!=null&&_3.isFunction(_31)){_33.on("error",_31);}var _35=this.operationalLayers;_33.on("load",function(){_35[_32]=_33;});VIEWER_UTILS.debug("Added Layer from URL: "+_2e);this.map.addLayer(_33);}else{if(_3.isFunction(_31)){_31("Could Not Add Layer");}}},_handleAddMapServiceLayer:function(_36,_37,_38,_39){var _3a=_3.hitch(this,_3.hitch(this,this._handleAddMapServiceServiceDescriptionLoaded,_36,_37,_38,_39));VIEWER_UTILS.getServiceDescription(_36,_3a,_39);},_handleAddMapServiceServiceDescriptionLoaded:function(_3b,_3c,_3d,_3e,_3f){var _40;if(_3f!=null&&_3.isObject(_3f)){if(this.isServiceTiledAndInMapSR(_3f)){_40=new _a(_3b);}else{_40=new _b(_3b);}_40.isOperationalLayer=_3c!=null&&_3c.isOperationalLayer!=null&&_3c.isOperationalLayer!=false;var _41=this.operationalLayers;_40.on("load",function(){_41[_40.url.toLowerCase()]=_40;});_40.serviceDescription=_3f;}if(_40!=null){_40.name=REG_EXP_UTILS.getServiceNameFromUrl(_3b);if(_3c!=null&&_3c.canRemove!=null){_40.canRemove=true;}if(_3d!=null&&_3.isFunction(_3d)){_40.on("load",_3d);}if(_3e!=null&&_3.isFunction(_3e)){_40.on("error",_3e);}VIEWER_UTILS.debug("Added Layer: "+_40.url);this.map.addLayer(_40);}},isServiceTiledAndInMapSR:function(_42){if(_42!=null&&_3.isObject(_42)){return _42.tileInfo!=null&&_42.spatialReference!=null&&_42.spatialReference.wkid==this.map.spatialReference.wkid;}return false;},handleLabelServiceExists:function(_43){if(_43!=null&&_3.isFunction(_43)){var _44=false;for(var key in this.labelServices){_44=true;break;}_43(_44);}},handleRemoveBasemap:function(id){var _45=this.basemaps[id];if(this.basemaps[id]!=null){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===id){this.map.removeLayer(this.currentBasemap);for(var key in this.basemaps){this.changeBaseMaps(key);break;}}delete this.basemaps[id];VIEWER_UTILS.debug("Removed Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVED,id);}},changeBaseMaps:function(key){var _46=this.basemaps[key];if(_46){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===key){return;}if(this.currentBasemap!=null){this.map.removeLayer(this.currentBasemap);}if(_46.isOpenStreetMap==null||_46.isOpenStreetMap==false){this.currentBasemap=new _a(_46.url);}else{this.currentBasemap=new _4();}this.map.addLayer(this.currentBasemap,0);VIEWER_UTILS.debug("Changed Basemap: "+key);this.currrentBasemapKey=key;}},handleGetCurrentBasemapUrl:function(_47){if(_47!=null&&_3.isFunction(_47)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_47(this.basemaps[this.currrentBasemapKey].url);return;}else{var _48;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_49){_48=_49;});if(_48){var _4a=_48.getSelected();if(_4a==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_3.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_47(this.webMapItem.itemData.baseMap.baseMapLayers[0].url);return;}}else{if(_4a&&_4a.layers&&_3.isArray(_4a.layers)&&_4a.layers.length>0){_47(_4a.layers[0].url);return;}}}}_47(null);}},handleGetCurrentBasemap:function(_4b){if(_4b!=null&&_3.isFunction(_4b)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_4b(this.currrentBasemapKey);return;}else{var _4c=null;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_4d){_4c=_4d;});if(_4c){var _4e=_4c.getSelected();if(_4e==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_3.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_4b(new _a(this.webMapItem.itemData.baseMap.baseMapLayers[0].url));return;}}else{_4b(_4e);return;}}}}_4b(null);},showLabelServices:function(){var _4f;for(var key in this.labelServices){_4f=this.labelServices[key];_4f.show();this.handleMoveLayerToTop(_4f);}VIEWER_UTILS.debug("Displayed Label Services");this.labelServicesVisible=true;},hideLabelServices:function(){for(var key in this.labelServices){this.labelServices[key].hide();}VIEWER_UTILS.debug("Hid Label Services");this.labelServicesVisible=false;},handleAddReferenceLayerRequest:function(_50,_51,_52){if(_50==null||_50.url==null||_50.url==""){if(_52!=null&&_3.isFunction(_52)){_52("Invalid Reference Layer");}}var id=VIEWER_UTILS.getLayerUniqueId(_50);if(this.labelServices[id]!=null){if(_52!=null&&_3.isFunction(_52)){_52("Reference Layer Already Exists");}}var _53=this._addReferenceLayer(_50);if(_53!=null){if(_51!=null&&_3.isFunction(_51)){_51(_53);}}else{if(_52!=null&&_3.isFunction(_52)){_52("Could not add reference layer");}}},_addReferenceLayers:function(){if(this.mapConfiguration.referenceLayers!=null&&_3.isArray(this.mapConfiguration.referenceLayers)){var _54;for(var i=0;i<this.mapConfiguration.referenceLayers.length;i++){_54=this.mapConfiguration.referenceLayers[i];this._addReferenceLayer(_54);}}},_addReferenceLayer:function(_55){var _56=this._getMapLayerFromLayerObject(_55);if(_56!=null){if(!this.labelServicesVisible){_56.hide();}else{_56.show();}var id=VIEWER_UTILS.getLayerUniqueId(_56);if(id==null){return;}this.labelServices[id]=_56;_56.isReferenceLayer=true;this.map.addLayer(_56);VIEWER_UTILS.log("Added Reference Layer: "+_56.url,VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_ADDED,_56);return _56;}return null;},handleRemoveReferenceLayerRequest:function(_57){var id=VIEWER_UTILS.getLayerUniqueId(_57);if(id==null){return;}if(this.labelServices[id]!=null){this.map.removeLayer(_57);delete this.labelServices[id];var _58=false;for(var key in this.labelServices){_58=true;break;}VIEWER_UTILS.log("Removed reference layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_REMOVED,_57,_58);}},addWebMapOperationalLayers:function(_59){var _5a;var _5b;for(var i=0;i<_59.itemData.operationalLayers.length;i++){_5a=_59.itemData.operationalLayers[i];_5b=_5a.layerObject;_5b.name=REG_EXP_UTILS.getServiceNameFromUrl(_5b.url);_5b.isOperationalLayer=true;var _5c=VIEWER_UTILS.getLayerUniqueId(_5b);if(this.operationalLayers[_5c]==null){this.operationalLayers[_5c]=_5b;}VIEWER_UTILS.getServiceDescription(_5b.url,_3.hitch(this,function(_5d,_5e){_5d.serviceDescription=_5e;this.handleLayerAdded(_5d);},_5b));}},_addOperationalLayers:function(){if(this.mapConfiguration.operationalLayers!=null&&_3.isArray(this.mapConfiguration.operationalLayers)){var _5f;for(var i=0;i<this.mapConfiguration.operationalLayers.length;i++){_5f=this.mapConfiguration.operationalLayers[i];var _60=this._getMapLayerFromLayerObject(_5f);if(_60!=null){VIEWER_UTILS.getServiceDescription(_5f.url,_3.hitch(this,function(_61,_62){_61.serviceDescription=_62;},_60));_60.name=REG_EXP_UTILS.getServiceNameFromUrl(_5f.url);if(_5f.label!=null&&_5f.label!=""){_60.layerAliasName=_5f.label;}this.map.addLayer(_60);_60.isOperationalLayer=true;var _63=VIEWER_UTILS.getLayerUniqueId(_60);if(this.operationalLayers[_63]==null){this.operationalLayers[_63]=_60;}}}}},_getMapLayerFromLayerObject:function(_64){if(_64.type==null||_64.type==""||_64.url==null||_64.url==""){return null;}var _65={};if(_64.visible!=null){_65.visible=_64.visible;}var _66=_64.type.toLowerCase();if(_66==="tiled"){return new _a(_64.url,_65);}else{if(_66==="dynamic"){var _67=new _b(_64.url,_65);if(_64.visibleLayerIds!=null&&_3.isArray(_64.visibleLayerIds)){_67.setVisibleLayers(_64.visibleLayerIds);}return _67;}else{if(_66==="image"){return new _7(_64.url,_65);}else{if(_66==="feature"){_65=_3.mixin(_65,{mode:_5.MODE_ONDEMAND,outFields:["*"]});var _68=new _5(_64.url,_65);if(_64.mapLabel!=null&&_64.mapLabel.field!=null&&_64.mapLabel.field!=""){this._createFeatureLayerLabels(_68,_64.mapLabel);}return _68;}else{if(_66==="kml"){return new _8(_64.url);}}}}}},loadMapConfigurationLayers:function(){this._addReferenceLayers();this._addOperationalLayers();},_createFeatureLayerLabels:function(_69,_6a){require(["esri/layers/LabelLayer","dojo/_base/Color","esri/renderers/SimpleRenderer","esri/symbols/TextSymbol"],_3.hitch(this,function(_6b,_6c,_6d,_6e){var _6f=_6a.color!=null?_6a.color:"#000";var _70=new _6b({id:VIEWER_UTILS.generateUUID()});var _71=new _6e().setColor(new _6c(_6f));var _72=_6a.fontSize!=null?_6a.fontSize:"12pt";_71.font.setSize(_72);var _73=_6a.fontFamily!=null?_6a.fontFamily:"arial";_71.font.setFamily(_73);var _74=new _6d(_71);_70.addFeatureLayer(_69,_74,"${"+_6a.field+"}");this.map.addLayer(_70);_69.on("visibility-change",_3.hitch(this,function(_75,e){if(e&&e.visible){_75.show();}else{_75.hide();}},_70));_69.on("opacity-change",_3.hitch(this,function(_76,e){if(e&&e.opacity!=null){_70.setOpacity(e.opacity);}},_70));}));}});});