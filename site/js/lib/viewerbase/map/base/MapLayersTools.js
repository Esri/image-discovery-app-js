//>>built
define("esriviewer/map/base/MapLayersTools",["dojo/_base/declare","dojo/topic","dojo/_base/connect","dojo/_base/lang","dojo/dom-construct","esri/layers/OpenStreetMapLayer","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/KMLLayer","esri/layers/WMSLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _1([],{labelServicesVisible:false,constructor:function(_e){_4.mixin(this,_e);this.loadViewerConfigurationData();this.currrentBasemapKey=null;this.labelServices={};this.timeEnabledLayers=[];this.operationalLayers={};this.graphicsLayers={};this._initListeners();},loadViewerConfigurationData:function(){if(this.mapConfiguration==null){var _f;_2.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_10){_f=_10;});if(_f){this.mapConfiguration=_f;}}},_initListeners:function(){_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVE,_4.hitch(this,this.handleRemoveBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_GRAPHICS_LAYER,_4.hitch(this,this.handleAddGraphicsLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADD,_4.hitch(this,this.handleAddBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.SET,_4.hitch(this,this.changeBaseMaps));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT_URL,_4.hitch(this,this.handleGetCurrentBasemapUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GET_CURRENT,_4.hitch(this,this.handleGetCurrentBasemap));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SHOW,_4.hitch(this,this.showLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.HIDE,_4.hitch(this,this.hideLabelServices));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LABEL_SERVICES.SERVICE_EXISTS,_4.hitch(this,this.handleLabelServiceExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.TIME.GET_TIME_ENABLED_SERVICES,_4.hitch(this,this.handleGetTimeEnabledLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.OPERATIONAL.GET,_4.hitch(this,this.handleGetOperationalLayers));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_FROM_URL,_4.hitch(this,this.handleAddLayerFromUrl));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD,_4.hitch(this,this.handleAddLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_EXTERNAL_MANAGED_LAYER,_4.hitch(this,this.handleAddExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_EXTERNAL_MANAGED_LAYER,_4.hitch(this,this.handleRemoveExternalManagedLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.GET_FEATURE_LAYER_IF_EXISTS,_4.hitch(this,this.handleGetFeatureLayerIfExists));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE,_4.hitch(this,this.handleRemoveLayer));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADD_REFERENCE_LAYER,_4.hitch(this,this.handleAddReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVE_REFERENCE_LAYER,_4.hitch(this,this.handleRemoveReferenceLayerRequest));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MOVE_LAYER_TO_TOP,_4.hitch(this,this.handleMoveLayerToTop));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_VISIBLE,_4.hitch(this,this.handleMakeLayerVisible));_2.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.MAKE_INVISIBLE,_4.hitch(this,this.handleMakeLayerInvisible));_3.connect(this.map,"onLayerAdd",this,this.handleLayerAdded);},handleMakeLayerVisible:function(_11){if(_11!=null){_11.show();}},handleMakeLayerInvisible:function(_12){if(_12!=null){_12.hide();}},handleMoveLayerToTop:function(_13){if(_13){this.map.reorderLayer(_13,this.map.layerIds.length);}},handleLayerAdded:function(_14){if(_14!=null&&_14.isReferenceLayer==null||!_14.isReferenceLayer){if(_14.timeInfo!=null){this.timeEnabledLayers.push(_14);VIEWER_UTILS.log("Found time enabled layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.TIME.TIME_LAYER_FOUND,_14);}}if(_14.isOperationalLayer!=null&&_14.isOperationalLayer===true){VIEWER_UTILS.log("Added operational layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.ADDED,_14);}},handleGetFeatureLayerIfExists:function(_15,_16){if(_15==null||_15==""||_16==null||!_4.isFunction(_16)){return;}var _17=_15.toLowerCase();_16(this.operationalLayers[_17]);},handleAddGraphicsLayer:function(_18){if(_18!=null){this.map.addLayer(_18);var _19=VIEWER_UTILS.generateUUID();_18.id=_19;this.graphicsLayers[_19]=_18;}},handleAddBasemap:function(_1a,_1b,_1c){var id=_1a.toLowerCase();if(this.basemaps[id]!=null){_1c("Basemap Already Exists");}var _1d=_4.hitch(this,this._handleBaseMapServiceDescriptionLoaded,_1a,_1b,_1c);VIEWER_UTILS.getServiceDescription(_1a,_1d);},_handleBaseMapServiceDescriptionLoaded:function(_1e,_1f,_20,_21){if(this.isServiceTiledAndInMapSR(_21)){var id=_1e.toLowerCase();var _22={id:id,label:REG_EXP_UTILS.getServiceNameFromUrl(_1e),url:_1e};this.basemaps[id]=_22;VIEWER_UTILS.debug("Added Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.ADDED,_22,id);if(_1f!=null&&_4.isFunction(_1f)){_1f(_22);}}else{if(_20!=null&&_4.isFunction(_20)){_20("Could not add basemap. Is the service cached and in the map spatial reference ("+this.map.spatialReference.wkid+")?");}}},handleRemoveLayer:function(_23){if(_23==null){return;}if(_23.url!=null){var _24=_23.url.toLowerCase();if(this.operationalLayers[_24]){delete this.operationalLayers[_24];}}if(_23 instanceof _8){if(this.graphicsLayers[_23.id]!=null){delete this.graphicsLayers[_23.id];}}this.map.removeLayer(_23);VIEWER_UTILS.debug("Removed Layer: "+_23.name);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REMOVED,_23);},handleGetOperationalLayers:function(_25){if(_25!=null&&_4.isFunction(_25)){var _26=[];for(var key in this.operationalLayers){_26.push(this.operationalLayers[key]);}_25(_26);}},handleGetTimeEnabledLayers:function(_27){if(_27!=null&&_4.isFunction(_27)){_27(this.timeEnabledLayers);}},handleRemoveExternalManagedLayer:function(_28){this.map.removeLayer(_28);},handleAddExternalManagedLayer:function(_29){this.map.addLayer(_29);},handleAddLayer:function(_2a,_2b,_2c,_2d){if(_2b&&_2b.isOperationalLayer!=false){if(_2a.url!=null){var _2e=_2a.url.toLowerCase();if(this.operationalLayers[_2e]!=null){return;}}this.operationalLayers[_2e]=_2a;_2a.isOperationalLayer=true;}else{_2a.isOperationalLayer=false;}_2a.canRemove=_2b!=null&&_2b.canRemove!=false;this.map.addLayer(_2a);if(_2c!=null&&_4.isFunction(_2c)){_3.connect(_2a,"onLoad",_2c);}if(_2d!=null&&_4.isFunction(_2d)){var _2f=function(){_2d(_2a);};_3.connect(_2a,"onError",this,_2f);}VIEWER_UTILS.debug("Added Layer: "+_2a.url);},handleAddLayerFromUrl:function(_30,_31,_32,_33){var _34=_30.toLowerCase();if(this.operationalLayers[_34]!=null){if(_33!=null&&_4.isFunction(_33)){_33("Layer has already been added to the map");}else{_2.publish(VIEWER_GLOBALS.EVENTS.MESSAGING.SHOW,"Layer has already been added to the map");}return;}var _35=null;var _36=VIEWER_UTILS.getServiceTypeFromUrl(_30);if(_36){if(_36==VIEWER_GLOBALS.SERVICE_TYPES.MAP_SERVER){if(REG_EXP_UTILS.isFeatureLayer(_30)){_35=new _7(_30,_4.mixin({mode:_7.MODE_ONDEMAND},_31||{}));}else{this._handleAddMapServiceLayer(_30,_31,_32,_33);return;}}else{if(_36==VIEWER_GLOBALS.SERVICE_TYPES.KML){_35=new _a(_30);}else{if(_36==VIEWER_GLOBALS.SERVICE_TYPES.IMAGE_SERVER){_35=new _9(_30);}else{if(_36===VIEWER_GLOBALS.SERVICE_TYPES.FEATURE_SERVER){_35=new _7(_30,_4.mixin({mode:_7.MODE_ONDEMAND},_31||{}));}}}}}else{if(_30.indexOf("/wms/")>-1){_35=new _b(_30,_31);}}if(_35){_35.canRemove=_31!=null&&_31.canRemove!=false;_35.isOperationalLayer=_31!=null&&_31.isOperationalLayer!=null&&_31.isOperationalLayer!=false;_35.layerAliasName=(_31&&_31.label)?_31.label:REG_EXP_UTILS.getServiceNameFromUrl(_30);if(_32!=null&&_4.isFunction(_32)){_3.connect(_35,"onLoad",_32);}if(_33!=null&&_4.isFunction(_33)){_3.connect(_35,"onError",_33);}var _37=this.operationalLayers;_3.connect(_35,"onLoad",function(){_37[_35.url.toLowerCase()]=_35;});VIEWER_UTILS.debug("Added Layer from URL: "+_30);this.map.addLayer(_35);}else{if(_4.isFunction(_33)){_33("Could Not Add Layer");}}},_handleAddMapServiceLayer:function(_38,_39,_3a,_3b){var _3c=_4.hitch(this,_4.hitch(this,this._handleAddMapServiceServiceDescriptionLoaded,_38,_39,_3a,_3b));VIEWER_UTILS.getServiceDescription(_38,_3c);},_handleAddMapServiceServiceDescriptionLoaded:function(_3d,_3e,_3f,_40,_41){var _42;var _43=_3d.toLowerCase();if(_41!=null&&_4.isObject(_41)){if(this.isServiceTiledAndInMapSR(_41)){_42=new _c(_3d);}else{_42=new _d(_3d);}_42.isOperationalLayer=_3e!=null&&_3e.isOperationalLayer!=null&&_3e.isOperationalLayer!=false;var _44=this.operationalLayers;_3.connect(_42,"onLoad",function(){_44[_42.url.toLowerCase()]=_42;});_42.serviceDescription=_41;}if(_42!=null){_42.name=REG_EXP_UTILS.getServiceNameFromUrl(_3d);if(_3e!=null&&_3e.canRemove!=null){_42.canRemove=true;}if(_3f!=null&&_4.isFunction(_3f)){_3.connect(_42,"onLoad",_3f);}if(_40!=null&&_4.isFunction(_40)){_3.connect(_42,"onError",_40);}VIEWER_UTILS.debug("Added Layer: "+_42.url);this.map.addLayer(_42);}},isServiceTiledAndInMapSR:function(_45){if(_45!=null&&_4.isObject(_45)){return _45.tileInfo!=null&&_45.spatialReference!=null&&_45.spatialReference.wkid==this.map.spatialReference.wkid;}return false;},handleLabelServiceExists:function(_46){if(_46!=null&&_4.isFunction(_46)){var _47=false;for(var key in this.labelServices){_47=true;break;}_46(_47);}},handleRemoveBasemap:function(id){var _48=this.basemaps[id];if(this.basemaps[id]!=null){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===id){this.map.removeLayer(this.currentBasemap);for(var key in this.basemaps){this.changeBaseMaps(key);break;}}delete this.basemaps[id];VIEWER_UTILS.debug("Removed Basemap: "+id);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.REMOVED,id);}},changeBaseMaps:function(key){var _49=this.basemaps[key];if(_49){if(this.currrentBasemapKey!=null&&this.currrentBasemapKey===key){return;}if(this.currentBasemap!=null){this.map.removeLayer(this.currentBasemap);}if(_49.isOpenStreetMap==null||_49.isOpenStreetMap==false){this.currentBasemap=new _c(_49.url);}else{this.currentBasemap=new _6();}this.map.addLayer(this.currentBasemap,0);VIEWER_UTILS.debug("Changed Basemap: "+key);this.currrentBasemapKey=key;}},handleGetCurrentBasemapUrl:function(_4a){if(_4a!=null&&_4.isFunction(_4a)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_4a(this.basemaps[this.currrentBasemapKey].url);return;}else{var _4b;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_4c){_4b=_4c;});if(_4b){var _4d=_4b.getSelected();if(_4d==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_4.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_4a(this.webMapItem.itemData.baseMap.baseMapLayers[0].url);return;}}else{if(_4d&&_4d.layers&&_4.isArray(_4d.layers)&&_4d.layers.length>0){_4a(_4d.layers[0].url);return;}}}}_4a(null);}},handleGetCurrentBasemap:function(_4e){if(_4e!=null&&_4.isFunction(_4e)){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){_4e(this.currrentBasemapKey);return;}else{var _4f;_2.publish(VIEWER_GLOBALS.EVENTS.MAP.BASEMAP.GALLERY.GET,function(_50){_4f=_50;});if(_4f){var _51=_4f.getSelected();if(_51==null){if(this.webMapItem&&this.webMapItem.itemData&&this.webMapItem.itemData.baseMap&&this.webMapItem.itemData.baseMap.baseMapLayers&&this.webMapItem.itemData.baseMap.baseMapLayers&&_4.isArray(this.webMapItem.itemData.baseMap.baseMapLayers)&&this.webMapItem.itemData.baseMap.baseMapLayers.length>0){_4e(new _c(this.webMapItem.itemData.baseMap.baseMapLayers[0].url));return;}}else{_4e(_51);return;}}}}_4e(null);},showLabelServices:function(){var _52;for(var key in this.labelServices){_52=this.labelServices[key];_52.show();this.handleMoveLayerToTop(_52);}VIEWER_UTILS.debug("Displayed Label Services");this.labelServicesVisible=true;},hideLabelServices:function(){for(var key in this.labelServices){this.labelServices[key].hide();}VIEWER_UTILS.debug("Hid Label Services");this.labelServicesVisible=false;},handleAddReferenceLayerRequest:function(_53,_54,_55){if(_53==null||_53.url==null||_53.url==""){if(_55!=null&&_4.isFunction(_55)){_55("Invalid Reference Layer");}}var id=_53.url.toLowerCase();if(this.labelServices[id]!=null){if(_55!=null&&_4.isFunction(_55)){_55("Reference Layer Already Exists");}}var _56=this._addReferenceLayer(_53);if(_56!=null){if(_54!=null&&_4.isFunction(_54)){_54(_56);}}else{if(_55!=null&&_4.isFunction(_55)){_55("Could not add reference layer");}}},addReferenceLayers:function(){if(this.mapConfiguration.referenceLayers!=null&&_4.isArray(this.mapConfiguration.referenceLayers)){var _57;for(var i=0;i<this.mapConfiguration.referenceLayers.length;i++){_57=this.mapConfiguration.referenceLayers[i];this._addReferenceLayer(_57);}}},_addReferenceLayer:function(_58){var _59=this._getMapLayerFromLayerObject(_58);if(_59!=null){if(!this.labelServicesVisible){_59.hide();}else{_59.show();}var id=_59.url.toLowerCase();this.labelServices[id]=_59;_59.isReferenceLayer=true;this.map.addLayer(_59);VIEWER_UTILS.log("Added Reference Layer: "+_59.url,VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_ADDED,_59);return _59;}return null;},handleRemoveReferenceLayerRequest:function(_5a){var id=_5a.url.toLowerCase();if(this.labelServices[id]!=null){this.map.removeLayer(_5a);delete this.labelServices[id];var _5b=false;for(var key in this.labelServices){_5b=true;break;}VIEWER_UTILS.log("Removed reference layer",VIEWER_GLOBALS.LOG_TYPE.INFO);_2.publish(VIEWER_GLOBALS.EVENTS.MAP.LAYERS.REFERENCE_LAYER_REMOVED,_5a,_5b);}},addWebMapOperationalLayers:function(_5c){var _5d;var _5e;for(var i=0;i<_5c.itemData.operationalLayers.length;i++){_5d=_5c.itemData.operationalLayers[i];_5e=_5d.layerObject;_5e.name=REG_EXP_UTILS.getServiceNameFromUrl(_5e.url);_5e.isOperationalLayer=true;var _5f=_5e.url.toLowerCase();if(this.operationalLayers[_5f]==null){this.operationalLayers[_5f]=_5e;}VIEWER_UTILS.getServiceDescription(_5e.url,_4.hitch(this,function(_60,_61){_60.serviceDescription=_61;this.handleLayerAdded(_60);},_5e));}},addOperationalLayers:function(){if(this.mapConfiguration.operationalLayers!=null&&_4.isArray(this.mapConfiguration.operationalLayers)){var _62;for(var i=0;i<this.mapConfiguration.operationalLayers.length;i++){_62=this.mapConfiguration.operationalLayers[i];var _63=this._getMapLayerFromLayerObject(_62);if(_63!=null){VIEWER_UTILS.getServiceDescription(_62.url,_4.hitch(this,function(_64,_65){_64.serviceDescription=_65;},_63));_63.name=REG_EXP_UTILS.getServiceNameFromUrl(_62.url);if(_62.label!=null&&_62.label!=""){_63.layerAliasName=_62.label;}this.map.addLayer(_63);_63.isOperationalLayer=true;var _66=_63.url.toLowerCase();if(this.operationalLayers[_66]==null){this.operationalLayers[_66]=_63;}}}}},_getMapLayerFromLayerObject:function(_67){if(_67.type==null||_67.type==""||_67.url==null||_67.url==""){return null;}var _68={};if(_67.visible!=null){_68.visible=_67.visible;}var _69=_67.type.toLowerCase();if(_69==="tiled"){return new _c(_67.url,_68);}else{if(_69==="dynamic"){var _6a=new _d(_67.url,_68);if(_67.visibleLayerIds!=null&&_4.isArray(_67.visibleLayerIds)){_6a.setVisibleLayers(_67.visibleLayerIds);}return _6a;}else{if(_69==="image"){return new _9(_67.url,_68);}else{if(_69==="feature"){_68=_4.mixin(_68,{mode:_7.MODE_ONDEMAND,outFields:["*"]});return new _7(_67.url,_68);}else{if(_69==="kml"){return new _a(_67.url);}}}}}}});});