//>>built
define("esriviewer/map/MapManager",["dojo/_base/declare","dojo/on","dojo/has","dojo/topic","dojo/_base/lang","./base/MapUtils","./base/MapExtentTools","./base/MapLayersTools","./base/MapDisplayWidgets","./base/MapNavDrawTools","./base/MapTimeTools","dijit/layout/ContentPane","../ui/basemap/BasemapGalleryWidget","esri/config","esri/geometry/Extent","esri/map","esri/arcgis/utils"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _1([],{__defaultZoomSliderPosition:{x:10,y:120},hasGeometryService:false,maxClientZoom:null,hideLatLongDisplay:false,hideMGRSDisplay:true,disableKeyboardNavigation:true,hideMapScale:false,constructor:function(_11){_4.mixin(this,_11||{});this.mapInitializationParameters={wrapAround180:true,force3DTransforms:false,navigationMode:"classic"};this.loadViewerConfigurationData();this.initMap();},loadViewerConfigurationData:function(){var _12=null;_3.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryService",function(_13){_12=_13;});this.hasGeometryService=_12!=null;var _14=null;_3.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_15){_14=_15;});if(_14&&_4.isObject(_14)){this.mapConfiguration=_14;this.basemaps=this.mapConfiguration.basemaps;var _16=false;if(this.mapConfiguration.display!=null&&_4.isObject(this.mapConfiguration.display)&&this.mapConfiguration.display.showScale!=null&&this.mapConfiguration.display.showScale==false){this.hideMapScale=true;}if(this.mapConfiguration.disableKeyboardNavigation!=null&&this.mapConfiguration.disableKeyboardNavigation==false){this.disableKeyboardNavigation=false;}if(this.mapConfiguration.maxClientZoom!=null){try{this.maxClientZoom=parseInt(this.mapConfiguration.maxClientZoom,10);}catch(err){}}_4.mixin(this.mapInitializationParameters,this.mapConfiguration.initializationParameters||{});}},initListeners:function(){this.map.on("load",_4.hitch(this,this.handleMapLoaded));this.map.on("update-start",function(){_3.publish(VIEWER_GLOBALS.EVENTS.THROBBER.SHOW);});this.map.on("zoom-end",_4.hitch(this,this.handleZoomLevelChanged));this.map.on("update-end",function(){_3.publish(VIEWER_GLOBALS.EVENTS.THROBBER.HIDE);});this.map.on("extent-change",_4.hitch(this,this.handleMapExtentChange));_3.subscribe(VIEWER_GLOBALS.EVENTS.MAP.GET,_4.hitch(this,this.handleGetMap));on(window,"resize",_4.hitch(this,function(){this.map.resize();}));},handleMapExtentChange:function(evt){if(!this.hideMapScale){this.mapExtentTools.handleMapExtentChanged();}_3.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.CHANGED,evt);},handleGetMap:function(_17){if(_17!=null&&_4.isFunction(_17)){_17(this.map);}},initMap:function(){var _18;_3.publish(VIEWER_GLOBALS.EVENTS.MAP.GET_MAP_DIV,function(mD){_18=mD;});this.mapDiv=_18;new _b({region:"center",style:"height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"},this.mapDiv);if(this.mapConfiguration.zoomSlider==null||this.mapConfiguration.zoomSlider.create!=false){var _19=this.__defaultZoomSliderPosition.x;var _1a=this.__defaultZoomSliderPosition.y;if(VIEWER_GLOBALS&&VIEWER_GLOBALS.windowPositioning&&VIEWER_GLOBALS.windowPositioning.zoomSlider&&_4.isObject(VIEWER_GLOBALS.windowPositioning.zoomSlider)){_19=VIEWER_GLOBALS.windowPositioning.zoomSlider.x;_1a=VIEWER_GLOBALS.windowPositioning.zoomSlider.y;var _1b="left";var _1c="top";if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY!=null&&_4.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY)){var _1d=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY.toLowerCase();if(_1d==="top"||_1d==="bottom"){_1c=_1d;}}if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX!=null&&_4.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX)){var _1e=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX.toLowerCase();if(_1e==="left"||_1e==="right"){_1b=_1e;}}}var _1f={width:null,height:"150px"};_1f[_1b]=_19+"px";_1f[_1c]=_1a+"px";if(_2("ie")){_1f.height="80px";}_d.defaults.map.slider=_1f;}else{this.mapInitializationParameters.slider=false;}if(this.mapConfiguration.initialExtent!=null&&_4.isObject(this.mapConfiguration.initialExtent)){var _20=this.mapConfiguration.initialExtent;this.initialExtent=new _e({xmin:_20.xmin,ymin:_20.ymin,xmax:_20.xmax,ymax:_20.ymax,spatialReference:_20.spatialReference});this.mapInitializationParameters.extent=this.initialExtent;}if(_4.isArray(this.mapConfiguration.lods)){this.mapInitializationParameters.lods=this.mapConfiguration.lods;}if(this.webMapItem){this.map=_10.createMap(this.webMapItem,this.mapDiv).then(_4.hitch(this,function(_21){this.mapCreated(_21.map);this.handleMapLoaded();}));}else{var map=new _f(this.mapDiv,this.mapInitializationParameters);if(this.disableKeyboardNavigation){map.disableKeyboardNavigation();}this.mapCreated(map);}},mapCreated:function(map){this.map=map;this.mapDisplayWidgets=new _8({map:this.map,mapDiv:this.mapDiv});this.mapExtentTools=new _6({mapDisplayWidgets:this.mapDisplayWidgets,map:this.map,mapUtils:this.mapUtils,maxClientZoom:this.maxClientZoom});this.mapLayersTools=new _7({map:this.map,basemaps:this.basemaps,mapConfiguration:this.mapConfiguration,webMapItem:this.webMapItem});this.mapUtils=new _5({map:this.map,mapDiv:this.mapDiv,operationalLayers:this.mapLayersTools.operationalLayers});this.mapNavDrawTools=new _9({map:this.map});this.mapTimeTools=new _a({map:this.map});this.initListeners();this.initBasemaps();},initBasemaps:function(){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){for(var key in this.basemaps){this.mapLayersTools.changeBaseMaps(key);break;}}else{this.basemapGalleryWidget=new _c();}},handleMapLoaded:function(){if(this.webMapItem&&this.webMapItem.itemData){this.mapLayersTools.addWebMapOperationalLayers(this.webMapItem);}else{this.mapLayersTools.loadMapConfigurationLayers();}if(this.mapConfiguration.overview==null||this.mapConfiguration.overview.create!=false){require(["esri/dijit/OverviewMap"],_4.hitch(this,function(_22){this.overviewMapDijit=new _22({attachTo:"bottom-right",color:"#D84E13",opacity:0.4,map:this.map,visible:true,width:225,height:175});this.overviewMapDijit.startup();}));}_3.publish(VIEWER_GLOBALS.EVENTS.MAP.LOADED,this.map);this.onMapLoaded();},handleZoomLevelChanged:function(evt){if(evt==null){return;}var _23=evt.extent;var _24=evt.zoomFactor;var _25=evt.anchor;var _26=evt.level;_3.publish(VIEWER_GLOBALS.EVENTS.MAP.LEVEL.CHANGED,_23,_24,_25,_26);},onMapLoaded:function(){}});});