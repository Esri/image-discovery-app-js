//>>built
define("esriviewer/map/MapManager",["dojo/_base/declare","dojo/_base/window","dojo/dom-construct","dojo/has","dojo/topic","dojo/_base/lang","dojo/dom","./base/MapUtils","./base/MapExtentTools","./base/MapLayersTools","./base/MapDisplayWidgets","./base/MapNavDrawTools","./base/MapTimeTools","./base/LayerQueryTools","dijit/layout/ContentPane","../ui/basemap/BasemapGalleryWidget","esri/dijit/OverviewMap","esri/config","esri/geometry/Extent","esri/map","esri/urlUtils","esri/arcgis/utils","./base/LayerQueryParameters"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,Map,_14,_15,_16){return _1([],{__defaultZoomSliderPosition:{x:10,y:120},hasGeometryService:false,maxClientZoom:null,hideLatLongDisplay:false,hideMGRSDisplay:true,hideMapScale:false,constructor:function(_17){_6.mixin(this,_17||{});this.mapInitializationParameters={wrapAround180:true,force3DTransforms:false,navigationMode:"classic"};this.loadViewerConfigurationData();this.initMap();this.layerQueryTools=new _e();},loadViewerConfigurationData:function(){var _18=null;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryService",function(_19){_18=_19;});this.hasGeometryService=_18!=null;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_1a){mapConfiguration=_1a;});if(mapConfiguration&&_6.isObject(mapConfiguration)){this.mapConfiguration=mapConfiguration;this.basemaps=this.mapConfiguration.basemaps;var _1b=false;if(this.mapConfiguration.display!=null&&_6.isObject(this.mapConfiguration.display)&&this.mapConfiguration.display.showScale!=null&&this.mapConfiguration.display.showScale==false){this.hideMapScale=true;}if(this.mapConfiguration.maxClientZoom!=null){try{this.maxClientZoom=parseInt(this.mapConfiguration.maxClientZoom,10);}catch(err){}}_6.mixin(this.mapInitializationParameters,this.mapConfiguration.initializationParameters||{});}},initListeners:function(){this.map.on("load",_6.hitch(this,this.handleMapLoaded));this.map.on("update-start",function(){_5.publish(VIEWER_GLOBALS.EVENTS.THROBBER.SHOW);});this.map.on("zoom-end",_6.hitch(this,this.handleZoomLevelChanged));this.map.on("update-end",function(){_5.publish(VIEWER_GLOBALS.EVENTS.THROBBER.HIDE);});if(!this.hideMapScale){this.map.on("extent-change",_6.hitch(this.mapExtentTools,this.mapExtentTools.handleMapExtentChanged));}_5.subscribe(VIEWER_GLOBALS.EVENTS.MAP.GET,_6.hitch(this,this.handleGetMap));},handleGetMap:function(_1c){if(_1c!=null&&_6.isFunction(_1c)){_1c(this.map);}},initMap:function(){var _1d;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.GET_MAP_DIV,function(mD){_1d=mD;});this.mapDiv=_1d;new _f({region:"center",style:"height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"},this.mapDiv);if(this.mapConfiguration.zoomSlider==null||this.mapConfiguration.zoomSlider.create!=false){var _1e=this.__defaultZoomSliderPosition.x;var _1f=this.__defaultZoomSliderPosition.y;if(VIEWER_GLOBALS&&VIEWER_GLOBALS.windowPositioning&&VIEWER_GLOBALS.windowPositioning.zoomSlider&&_6.isObject(VIEWER_GLOBALS.windowPositioning.zoomSlider)){_1e=VIEWER_GLOBALS.windowPositioning.zoomSlider.x;_1f=VIEWER_GLOBALS.windowPositioning.zoomSlider.y;var _20="left";var _21="top";if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY!=null&&_6.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY)){var _22=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY.toLowerCase();if(_22==="top"||_22==="bottom"){_21=_22;}}if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX!=null&&_6.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX)){var _23=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX.toLowerCase();if(_23==="left"||_23==="right"){_20=_23;}}}var _24={width:null,height:"150px"};_24[_20]=_1e+"px";_24[_21]=_1f+"px";if(_4("ie")){_24.height="80px";}_12.defaults.map.slider=_24;}else{this.mapInitializationParameters.slider=false;}if(this.mapConfiguration.initialExtent!=null&&_6.isObject(this.mapConfiguration.initialExtent)){var _25=this.mapConfiguration.initialExtent;this.initialExtent=new _13({xmin:_25.xmin,ymin:_25.ymin,xmax:_25.xmax,ymax:_25.ymax,spatialReference:_25.spatialReference});this.mapInitializationParameters.extent=this.initialExtent;}if(_6.isArray(this.mapConfiguration.lods)){this.mapInitializationParameters.lods=this.mapConfiguration.lods;}if(this.webMapItem){this.map=_15.createMap(this.webMapItem,this.mapDiv).then(_6.hitch(this,function(_26){this.mapCreated(_26.map);this.handleMapLoaded();}));}else{var map=new Map(this.mapDiv,this.mapInitializationParameters);this.mapCreated(map);}},mapCreated:function(map){this.map=map;this.mapDisplayWidgets=new _b({map:this.map,mapDiv:this.mapDiv});this.mapExtentTools=new _9({mapDisplayWidgets:this.mapDisplayWidgets,map:this.map,mapUtils:this.mapUtils,maxClientZoom:this.maxClientZoom});this.mapLayersTools=new _a({map:this.map,basemaps:this.basemaps,mapConfiguration:this.mapConfiguration,webMapItem:this.webMapItem});this.mapUtils=new _8({map:this.map,mapDiv:this.mapDiv,operationalLayers:this.mapLayersTools.operationalLayers});this.mapNavDrawTools=new _c({map:this.map});this.mapTimeTools=new _d({map:this.map});this.initListeners();this.initBasemaps();},initBasemaps:function(){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){for(var key in this.basemaps){this.mapLayersTools.changeBaseMaps(key);break;}}else{this.basemapGalleryWidget=new _10();_5.publish(VIEWER_GLOBALS.EVENTS.PLACEMENT.GLOBAL.PLACE.BASEMAP_GALLERY,this.basemapGalleryWidget);this.basemapGalleryWidget.startup();}},handleMapLoaded:function(){if(this.webMapItem&&this.webMapItem.itemData){this.mapLayersTools.addWebMapOperationalLayers(this.webMapItem);}else{this.mapLayersTools.addReferenceLayers();this.mapLayersTools.addOperationalLayers();}if(this.mapConfiguration.overview==null||this.mapConfiguration.overview.create!=false){this.overviewMapDijit=new _11({attachTo:"bottom-right",color:"#D84E13",opacity:0.4,map:this.map,visible:true,width:225,height:175});this.overviewMapDijit.startup();}_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LOADED,this.map);this.onMapLoaded();},handleZoomLevelChanged:function(evt){if(evt==null){return;}var _27=evt.extent;var _28=evt.zoomFactor;var _29=evt.anchor;var _2a=evt.level;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LEVEL.CHANGED,_27,_28,_29,_2a);},onMapLoaded:function(){}});});