//>>built
define("esriviewer/map/MapManager",["dojo/_base/declare","dojo/on","dojo/dom-construct","dojo/has","dojo/topic","dojo/_base/lang","dojo/dom","./base/MapUtils","./base/MapExtentTools","./base/MapLayersTools","./base/MapDisplayWidgets","./base/MapNavDrawTools","./base/MapTimeTools","dijit/layout/ContentPane","../ui/basemap/BasemapGalleryWidget","esri/dijit/OverviewMap","esri/config","esri/geometry/Extent","esri/map","esri/urlUtils","esri/arcgis/utils"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,Map,_12,_13){return _1([],{__defaultZoomSliderPosition:{x:10,y:120},hasGeometryService:false,maxClientZoom:null,hideLatLongDisplay:false,hideMGRSDisplay:true,hideMapScale:false,constructor:function(_14){_5.mixin(this,_14||{});this.mapInitializationParameters={wrapAround180:true,force3DTransforms:false,navigationMode:"classic"};this.loadViewerConfigurationData();this.initMap();},loadViewerConfigurationData:function(){var _15=null;_4.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryService",function(_16){_15=_16;});this.hasGeometryService=_15!=null;var _17;_4.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_18){_17=_18;});if(_17&&_5.isObject(_17)){this.mapConfiguration=_17;this.basemaps=this.mapConfiguration.basemaps;var _19=false;if(this.mapConfiguration.display!=null&&_5.isObject(this.mapConfiguration.display)&&this.mapConfiguration.display.showScale!=null&&this.mapConfiguration.display.showScale==false){this.hideMapScale=true;}if(this.mapConfiguration.maxClientZoom!=null){try{this.maxClientZoom=parseInt(this.mapConfiguration.maxClientZoom,10);}catch(err){}}_5.mixin(this.mapInitializationParameters,this.mapConfiguration.initializationParameters||{});}},initListeners:function(){this.map.on("load",_5.hitch(this,this.handleMapLoaded));this.map.on("update-start",function(){_4.publish(VIEWER_GLOBALS.EVENTS.THROBBER.SHOW);});this.map.on("zoom-end",_5.hitch(this,this.handleZoomLevelChanged));this.map.on("update-end",function(){_4.publish(VIEWER_GLOBALS.EVENTS.THROBBER.HIDE);});this.map.on("extent-change",_5.hitch(this,this.handleMapExtentChange));_4.subscribe(VIEWER_GLOBALS.EVENTS.MAP.GET,_5.hitch(this,this.handleGetMap));on(window,"resize",_5.hitch(this,function(){this.map.resize();}));},handleMapExtentChange:function(evt){if(!this.hideMapScale){this.mapExtentTools.handleMapExtentChanged();}_4.publish(VIEWER_GLOBALS.EVENTS.MAP.EXTENT.CHANGED,evt);},handleGetMap:function(_1a){if(_1a!=null&&_5.isFunction(_1a)){_1a(this.map);}},initMap:function(){var _1b;_4.publish(VIEWER_GLOBALS.EVENTS.MAP.GET_MAP_DIV,function(mD){_1b=mD;});this.mapDiv=_1b;new _d({region:"center",style:"height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"},this.mapDiv);if(this.mapConfiguration.zoomSlider==null||this.mapConfiguration.zoomSlider.create!=false){var _1c=this.__defaultZoomSliderPosition.x;var _1d=this.__defaultZoomSliderPosition.y;if(VIEWER_GLOBALS&&VIEWER_GLOBALS.windowPositioning&&VIEWER_GLOBALS.windowPositioning.zoomSlider&&_5.isObject(VIEWER_GLOBALS.windowPositioning.zoomSlider)){_1c=VIEWER_GLOBALS.windowPositioning.zoomSlider.x;_1d=VIEWER_GLOBALS.windowPositioning.zoomSlider.y;var _1e="left";var _1f="top";if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY!=null&&_5.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY)){var _20=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY.toLowerCase();if(_20==="top"||_20==="bottom"){_1f=_20;}}if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX!=null&&_5.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX)){var _21=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX.toLowerCase();if(_21==="left"||_21==="right"){_1e=_21;}}}var _22={width:null,height:"150px"};_22[_1e]=_1c+"px";_22[_1f]=_1d+"px";if(_3("ie")){_22.height="80px";}_10.defaults.map.slider=_22;}else{this.mapInitializationParameters.slider=false;}if(this.mapConfiguration.initialExtent!=null&&_5.isObject(this.mapConfiguration.initialExtent)){var _23=this.mapConfiguration.initialExtent;this.initialExtent=new _11({xmin:_23.xmin,ymin:_23.ymin,xmax:_23.xmax,ymax:_23.ymax,spatialReference:_23.spatialReference});this.mapInitializationParameters.extent=this.initialExtent;}if(_5.isArray(this.mapConfiguration.lods)){this.mapInitializationParameters.lods=this.mapConfiguration.lods;}if(this.webMapItem){this.map=_13.createMap(this.webMapItem,this.mapDiv).then(_5.hitch(this,function(_24){this.mapCreated(_24.map);this.handleMapLoaded();}));}else{var map=new Map(this.mapDiv,this.mapInitializationParameters);this.mapCreated(map);}},mapCreated:function(map){this.map=map;this.mapDisplayWidgets=new _a({map:this.map,mapDiv:this.mapDiv});this.mapExtentTools=new _8({mapDisplayWidgets:this.mapDisplayWidgets,map:this.map,mapUtils:this.mapUtils,maxClientZoom:this.maxClientZoom});this.mapLayersTools=new _9({map:this.map,basemaps:this.basemaps,mapConfiguration:this.mapConfiguration,webMapItem:this.webMapItem});this.mapUtils=new _7({map:this.map,mapDiv:this.mapDiv,operationalLayers:this.mapLayersTools.operationalLayers});this.mapNavDrawTools=new _b({map:this.map});this.mapTimeTools=new _c({map:this.map});this.initListeners();this.initBasemaps();},initBasemaps:function(){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){for(var key in this.basemaps){this.mapLayersTools.changeBaseMaps(key);break;}}else{this.basemapGalleryWidget=new _e();}},handleMapLoaded:function(){if(this.webMapItem&&this.webMapItem.itemData){this.mapLayersTools.addWebMapOperationalLayers(this.webMapItem);}else{this.mapLayersTools.loadMapConfigurationLayers();}if(this.mapConfiguration.overview==null||this.mapConfiguration.overview.create!=false){this.overviewMapDijit=new _f({attachTo:"bottom-right",color:"#D84E13",opacity:0.4,map:this.map,visible:true,width:225,height:175});this.overviewMapDijit.startup();}_4.publish(VIEWER_GLOBALS.EVENTS.MAP.LOADED,this.map);this.onMapLoaded();},handleZoomLevelChanged:function(evt){if(evt==null){return;}var _25=evt.extent;var _26=evt.zoomFactor;var _27=evt.anchor;var _28=evt.level;_4.publish(VIEWER_GLOBALS.EVENTS.MAP.LEVEL.CHANGED,_25,_26,_27,_28);},onMapLoaded:function(){}});});