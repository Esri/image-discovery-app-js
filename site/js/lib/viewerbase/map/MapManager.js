//>>built
define("esriviewer/map/MapManager",["dojo/_base/declare","dojo/_base/window","dojo/dom-construct","dojo/has","dojo/topic","dojo/_base/connect","dojo/_base/lang","dojo/dom","./base/MapUtils","./base/MapExtentTools","./base/MapLayersTools","./base/MapDisplayWidgets","./base/MapNavDrawTools","./base/MapTimeTools","./base/LayerQueryTools","dijit/layout/ContentPane","../ui/basemap/BasemapGalleryWidget","esri/dijit/OverviewMap","esri/config","esri/geometry/Extent","esri/map","esri/urlUtils","esri/arcgis/utils","./base/LayerQueryParameters"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,Map,_15,_16,_17){return _1([],{__defaultZoomSliderPosition:{x:10,y:120},hasGeometryService:false,maxClientZoom:null,hideLatLongDisplay:false,hideMGRSDisplay:true,hideMapScale:false,constructor:function(_18){_7.mixin(this,_18||{});this.mapInitializationParameters={wrapAround180:true,force3DTransforms:false,navigationMode:"classic"};this.loadViewerConfigurationData();this.initMap();this.layerQueryTools=new _f();},loadViewerConfigurationData:function(){var _19=null;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"geometryService",function(_1a){_19=_1a;});this.hasGeometryService=_19!=null;_5.publish(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,"map",function(_1b){mapConfiguration=_1b;});if(mapConfiguration&&_7.isObject(mapConfiguration)){this.mapConfiguration=mapConfiguration;this.basemaps=this.mapConfiguration.basemaps;var _1c=false;if(this.mapConfiguration.display!=null&&_7.isObject(this.mapConfiguration.display)&&this.mapConfiguration.display.showScale!=null&&this.mapConfiguration.display.showScale==false){this.hideMapScale=true;}if(this.mapConfiguration.maxClientZoom!=null){try{this.maxClientZoom=parseInt(this.mapConfiguration.maxClientZoom,10);}catch(err){}}_7.mixin(this.mapInitializationParameters,this.mapConfiguration.initializationParameters||{});}},initListeners:function(){_6.connect(this.map,"onLoad",_7.hitch(this,this.handleMapLoaded));_6.connect(this.map,"onUpdateStart",function(){_5.publish(VIEWER_GLOBALS.EVENTS.THROBBER.SHOW);});_6.connect(this.map,"onUpdateEnd",function(){_5.publish(VIEWER_GLOBALS.EVENTS.THROBBER.HIDE);});if(!this.hideMapScale){_6.connect(this.map,"onExtentChange",_7.hitch(this.mapExtentTools,this.mapExtentTools.handleMapExtentChanged));}_5.subscribe(VIEWER_GLOBALS.EVENTS.MAP.GET,_7.hitch(this,this.handleGetMap));},handleGetMap:function(_1d){if(_1d!=null&&_7.isFunction(_1d)){_1d(this.map);}},initMap:function(){var _1e;_5.publish(VIEWER_GLOBALS.EVENTS.MAP.GET_MAP_DIV,function(mD){_1e=mD;});this.mapDiv=_1e;new _10({region:"center",style:"height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"},this.mapDiv);if(this.mapConfiguration.zoomSlider==null||this.mapConfiguration.zoomSlider.create!=false){var _1f=this.__defaultZoomSliderPosition.x;var _20=this.__defaultZoomSliderPosition.y;if(VIEWER_GLOBALS&&VIEWER_GLOBALS.windowPositioning&&VIEWER_GLOBALS.windowPositioning.zoomSlider&&_7.isObject(VIEWER_GLOBALS.windowPositioning.zoomSlider)){_1f=VIEWER_GLOBALS.windowPositioning.zoomSlider.x;_20=VIEWER_GLOBALS.windowPositioning.zoomSlider.y;var _21="left";var _22="top";if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY!=null&&_7.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY)){var _23=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignY.toLowerCase();if(_23==="top"||_23==="bottom"){_22=_23;}}if(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX!=null&&_7.isString(VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX)){var _24=VIEWER_GLOBALS.windowPositioning.zoomSlider.alignX.toLowerCase();if(_24==="left"||_24==="right"){_21=_24;}}}var _25={width:null,height:"150px"};_25[_21]=_1f+"px";_25[_22]=_20+"px";if(_4("ie")){_25.height="80px";}_13.defaults.map.slider=_25;}else{this.mapInitializationParameters.slider=false;}if(!this.hasGeometryService&&this.mapConfiguration.initialExtent!=null&&_7.isObject(this.mapConfiguration.initialExtent)){var _26=this.mapConfiguration.initialExtent;this.initialExtent=new _14({xmin:_26.xmin,ymin:_26.ymin,xmax:_26.xmax,ymax:_26.ymax,spatialReference:_26.spatialReference});this.mapInitializationParameters.extent=this.initialExtent;}if(_7.isArray(this.mapConfiguration.lods)){this.mapInitializationParameters.lods=this.mapConfiguration.lods;}if(this.webMapItem){this.map=_16.createMap(this.webMapItem,this.mapDiv).then(_7.hitch(this,function(_27){this.mapCreated(_27.map);this.handleMapLoaded();}));}else{var map=new Map(this.mapDiv,this.mapInitializationParameters);this.mapCreated(map);}},mapCreated:function(map){this.map=map;this.mapDisplayWidgets=new _c({map:this.map,mapDiv:this.mapDiv});this.mapExtentTools=new _a({mapDisplayWidgets:this.mapDisplayWidgets,map:this.map,mapUtils:this.mapUtils,maxClientZoom:this.maxClientZoom});this.mapLayersTools=new _b({map:this.map,basemaps:this.basemaps,mapConfiguration:this.mapConfiguration,webMapItem:this.webMapItem});this.mapUtils=new _9({map:this.map,mapDiv:this.mapDiv,operationalLayers:this.mapLayersTools.operationalLayers});this.mapNavDrawTools=new _d({map:this.map});this.mapTimeTools=new _e({map:this.map});this.initListeners();this.initBasemaps();},initBasemaps:function(){if(this.mapConfiguration.useBasemapGallery==null||this.mapConfiguration.useBasemapGallery!=true){for(var key in this.basemaps){this.mapLayersTools.changeBaseMaps(key);break;}}else{this.basemapGalleryWidget=new _11();_5.publish(VIEWER_GLOBALS.EVENTS.PLACEMENT.GLOBAL.PLACE.BASEMAP_GALLERY,this.basemapGalleryWidget);this.basemapGalleryWidget.startup();}},handleMapLoaded:function(){if(this.webMapItem&&this.webMapItem.itemData){this.mapLayersTools.addWebMapOperationalLayers(this.webMapItem);}else{this.mapLayersTools.addReferenceLayers();this.mapLayersTools.addOperationalLayers();}if(this.mapConfiguration.overview==null||this.mapConfiguration.overview.create!=false){this.overviewMapDijit=new _12({attachTo:"bottom-right",color:"#D84E13",opacity:0.4,map:this.map,visible:true,width:225,height:175});this.overviewMapDijit.startup();}_5.publish(VIEWER_GLOBALS.EVENTS.MAP.LOADED,this.map);this.onMapLoaded();},_getLayerFromUrl:function(_28){var _29;for(var i=0;i<this.map.layerIds;i++){}},onMapLoaded:function(){}});});