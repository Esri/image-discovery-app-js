//>>built
define("esriviewer/manager/base/ViewerManager",["dojo/_base/declare","dojox/storage","dojo/topic","dojo/_base/window","dojo/_base/lang","./IdentityManagerMixin","../../base/Configurable","../../base/LocationServiceSupport","../../base/DataLoaderSupport","../../ui/tools/ViewerDefaultTools","../../map/MapManager","../../ui/toolbar/ActionsToolbarWidget","../../ui/bookmark/BookmarkController","../../portal/PortalViewerManagerSupportMixin","../../map/geometry/GeometryServiceController","../../ui/accordion/ToolsAccordion","./ViewerManagerUI","./WebMapTemplateConfigurationUtil","esri/urlUtils","esri/arcgis/utils","../../map/base/LayerQueryTools"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15){return _1([_e,_7,_8,_9,_11,_6],{portalSharingRestUrl:"/sharing/rest",portalContentUrl:"/sharing/rest/content/items",baseConfigurationLoaded:false,forceHideCoreTimeSlider:false,useProxyForConfig:false,useProxyForPositionConfig:false,allowAccordionMove:true,allowAccordionCollapse:true,forceHideAccordionTab:false,configUrl:"config/baseConfig.json",viewerPositioningConfigUrl:"config/viewerPositioning.json",constructor:function(_16){_5.mixin(this,_16||{});this._initializeStorageProvider();var _17=_13.urlToObject(document.location.href);this.appId=_17.query?_17.query.appid:null;this.processConfig();},processConfig:function(){if(this.appId!=null){var _18=new _12();_18.loadConfiguration(this.appId).then(_5.hitch(this,this._handleWebMapTemplateConfigurationLoaded));}else{if(this.useProxyForConfig){this.loadProxiedConfig();}else{this.loadConfig();}}},_handleWebMapTemplateConfigurationLoaded:function(_19){this.handleConfigLoaded(_19);},handleConfigLoaded:function(_1a){VIEWER_UTILS.debug("Configuration Loaded");this.viewerConfig=_1a;if(_1a.windowTitle){_4.doc.title=_1a.windowTitle;}else{_4.doc.title="JavaScript Map Viewer";}if(this.viewerConfig&&this.viewerConfig.portal!=null&&_5.isObject(this.viewerConfig.portal)&&this.viewerConfig.portal.url){var _1b=this.viewerConfig.portal.url;var _1c=_1b.toLowerCase();if(_1c.indexOf("http://")<0&&_1c.indexOf("https://")<0){_1b="http://"+_1b;}_14.arcgisUrl=VIEWER_UTILS.joinUrl(_1b,this.portalContentUrl);}if(this.useProxyForPositionConfig){this.loadProxiedJson(this.viewerPositioningConfigUrl,_5.hitch(this,this.handleWindowPositionsConfigLoaded),_5.hitch(this,this.handleWindowPositionsConfigLoadFailed));}else{this.loadJson(this.viewerPositioningConfigUrl,_5.hitch(this,this.handleWindowPositionsConfigLoaded),_5.hitch(this,this.handleWindowPositionsConfigLoadFailed));}},startupViewer:function(){this._initListeners();this.initListeners();this._createViewerManager();this.createLayerQueryTools();},createLayerQueryTools:function(){this.layerQueryTools=new _15();},initListeners:function(){},_initListeners:function(){this.inherited(arguments);_3.subscribe(VIEWER_GLOBALS.EVENTS.MAP.LOADED,_5.hitch(this,this.handleMapLoaded));_3.subscribe(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET,_5.hitch(this,this.handleGetConfiguration));_3.subscribe(VIEWER_GLOBALS.EVENTS.CONFIGURATION.GET_ENTRY,_5.hitch(this,this.handleGetConfigurationKey));},handleGetConfiguration:function(_1d){if(_1d&&_5.isFunction(_1d)){_1d(this.viewerConfig);}},handleGetConfigurationKey:function(key,_1e){if(key!=null&&key!=""&&_1e&&_5.isFunction(_1e)){_1e(this.viewerConfig[key]);}},handleMapLoaded:function(map){this.map=map;PROJECTION_UTILS.setMapSpatialReference(map.spatialReference);this.loadControllers();this.loadUI();},loadUI:function(){this.inherited(arguments);},_initializePortalSupport:function(){return this.inherited(arguments);},loadControllers:function(){if(this.viewerConfig.geometryServiceUrl!=null&&this.viewerConfig.geometryServiceUrl){this.geometryServiceController=new _f();_3.publish(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.CONTROLLER_CREATED);}else{_3.subscribe(VIEWER_GLOBALS.EVENTS.GEOMETRY_SERVICE.EXISTS,_5.hitch(this,function(_1f){if(_1f!=null&&_5.isFunction(_1f)){_1f(false);}}));}if(this.viewerConfig.locators!=null&&_5.isArray(this.viewerConfig.locators)){for(var i=0;i<this.viewerConfig.locators.length;i++){this.addLocator(this.viewerConfig.locators[i].url,this.viewerConfig.locators[i].label);}}this._createBookmarkController();},handleWindowPositionsConfigLoaded:function(_20){VIEWER_GLOBALS.windowPositioning=_20;this.createMessagingAndLogging();if(!this.baseConfigurationLoaded){this.handleBaseConfigurationsLoaded();}},handleWindowPositionsConfigLoadFailed:function(){VIEWER_GLOBALS.windowPositioning={};this.createMessagingAndLogging();if(!this.baseConfigurationLoaded){this.handleBaseConfigurationsLoaded();}},createMessagingAndLogging:function(){this._createLoggingWidget();this._createMessagingWidget();},handleBaseConfigurationsLoaded:function(){this.baseConfigurationLoaded=true;this.startupViewer();},_createViewerManager:function(){this._createLayersWidget();if(this._initializePortalSupport!=null&&_5.isFunction(this._initializePortalSupport)){_3.subscribe(VIEWER_GLOBALS.EVENTS.PORTAL.INITIALIZED,_5.hitch(this,function(){this.mapManager=new _b({webMapItem:this.viewerConfig.webMapItem});}));var _21=this._initializePortalSupport();if(!_21){this.mapManager=new _b();}}else{this.mapManager=new _b();}},_createLayersWidget:function(){this.createLayersWidget();},createLayersWidget:function(){},_createBookmarkController:function(){this.bookmarkController=new _d();},_loadBookmarks:function(){if(_5.isObject(this.viewerConfig.bookmarks)&&this.viewerConfig.bookmarks.url!=null){var _22=_5.hitch(this,function(_23){this._setServerBookmarks(_23);});this.loadJson(this.viewerConfig.bookmarks.url,_22);}this.mainToolbar.loadCookieBookmarks();},_setServerBookmarks:function(_24){this.mainToolbar.addStaticBookmarks(_24);},_initializeStorageProvider:function(){var _25=dojox.storage.manager.getProvider();_25.initialize();},processNavigationToolbarAddons:function(){},createViewerDefaultTools:function(){this.viewerDefaultTools=new _a();this.createAddonTools();this.viewerDefaultTools.createConfigurationMenuItem();},_createViewerAccordion:function(){if(this.viewerConfig.toolsAccordion.create==null||this.viewerConfig.toolsAccordion.create!=false){_3.subscribe(VIEWER_GLOBALS.EVENTS.TOOLS.ACCORDION.LOAD_DEFAULT_TOOLS,_5.hitch(this,this.createDefaultAccordionTools));this.viewerAccordion=new _10({allowCollapse:this.allowAccordionCollapse,movable:this.allowAccordionMove});_3.publish(VIEWER_GLOBALS.EVENTS.PLACEMENT.GLOBAL.PLACE.VIEWER_ACCORDION,this.viewerAccordion);}},_createViewerMainToolbar:function(){this.mainToolbar=new _c();_3.publish(VIEWER_GLOBALS.EVENTS.PLACEMENT.GLOBAL.PLACE.MAIN_TOOLBAR,this.mainToolbar);if(_5.isObject(this.viewerConfig.map)){this.mainToolbar.setBasemaps(this.viewerConfig.map.basemaps);}},createDefaultAccordionTools:function(){},handleToggleAccordion:function(){this.viewerAccordion.toggle();},createAddonTools:function(){}});});