//>>built
define("dgrid/tree",["dojo/_base/declare","dojo/_base/array","dojo/_base/Deferred","dojo/has","dojo/query","dojo/on","dojo/aspect","./Grid","dojo/has!touch?./util/touch","put-selector/put"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9){return function(_a){var _b=_a.renderCell||_7.defaultRenderCell;var _c,_d;if(!_a){_a={};}_a.shouldExpand=_a.shouldExpand||function(_e,_f,_10){return _10;};_6.after(_a,"init",function(){var _11=_a.grid,_12=".dgrid-content .dgrid-column-"+_a.id,_13,_14=[],tr,_15;if(!_11.store){throw new Error("dgrid tree column plugin requires a store to operate.");}if(!_a.renderExpando){_a.renderExpando=function(_16,_17,_18){var dir=this.grid.isRTL?"right":"left",cls=".dgrid-expando-icon",_19;if(_17){cls+=".ui-icon.ui-icon-triangle-1-"+(_18?"se":"e");}_19=_9("div"+cls+"[style=margin-"+dir+": "+(_16*(this.indentWidth||9))+"px; float: "+dir+"]");_19.innerHTML="&nbsp;";return _19;};}_14.push(_11.on(_a.expandOn||".dgrid-expando-icon:click,"+_12+":dblclick,"+_12+":keydown",function(_1a){var row=_11.row(_1a);if((!_11.store.mayHaveChildren||_11.store.mayHaveChildren(row.data))&&(_1a.type!="keydown"||_1a.keyCode==32)&&!(_1a.type=="dblclick"&&_d&&_d.count>1&&row.id==_d.id&&_1a.target.className.indexOf("dgrid-expando-icon")>-1)){_11.expand(row);}if(_1a.target.className.indexOf("dgrid-expando-icon")>-1){if(_d&&_d.id==_11.row(_1a).id){_d.count++;}else{_d={id:_11.row(_1a).id,count:1};}}}));if(_4("touch")){_14.push(_11.on(_8.selector(_12,_8.dbltap),function(){_11.expand(this);}));}if(!_11._expanded){_11._expanded={};}_14.push(_6.after(_11,"insertRow",function(_1b){var row=this.row(_1b),_1c=_a.shouldExpand(row,_c,this._expanded[row.id]);if(_1c){this.expand(_1b,true,true);}return _1b;}));_14.push(_6.before(_11,"removeRow",function(_1d,_1e){var _1f=_1d.connected;if(_1f){_5(">.dgrid-row",_1f).forEach(function(_20){_11.removeRow(_20,true);});if(!_1e){_9(_1f,"!");}}}));if(_a.collapseOnRefresh){_14.push(_6.after(_11,"cleanup",function(){this._expanded={};}));}_11._calcRowHeight=function(_21){var _22=_21.connected;return _21.offsetHeight+(_22?_22.offsetHeight:0);};_11.expand=function(_23,_24,_25){var row=_23.element?_23:_11.row(_23);_23=row.element;_23=_23.className.indexOf("dgrid-expando-icon")>-1?_23:_5(".dgrid-expando-icon",_23)[0];if(_23&&_23.mayHaveChildren){var _26=_24===undefined?!this._expanded[row.id]:_24;_23.className="dgrid-expando-icon ui-icon ui-icon-triangle-1-"+(_26?"se":"e");var _27=_23.preloadNode,_28=row.element,_29,_2a;if(!_27){_29=_28.connected=_9("div.dgrid-tree-container");_27=_23.preloadNode=_9(_28,"+",_29,"div.dgrid-preload");var _2b=function(_2c){return _11.store.getChildren(row.data,_2c);};_2b.level=_23.level;if(_a.allowDuplicates){_2a={parentId:row.id};}_3.when(_11.renderQuery?_11._trackError(function(){return _11.renderQuery(_2b,_27,_2a);}):_11.renderArray(_2b(_2a),_27,{query:_2b}),function(){if(_11._expanded[row.id]){var _2d=_29.scrollHeight;_29.style.height=_2d?_2d+"px":"auto";}});var _2e=function(_2f){var _30=this.style.height;if(_30){this.style.display=_30=="0px"?"none":"block";}if(_2f){_9(this,".dgrid-tree-resetting");setTimeout(function(){_9(_29,"!dgrid-tree-resetting");});_13=true;}else{if(!_13){_13=false;}}this.style.height="";};on(_29,"transitionend,webkitTransitionEnd,oTransitionEnd,MSTransitionEnd",_2e);if(!_13){setTimeout(function(){_2e.call(_29);},600);}}_29=_28.connected;_29.hidden=!_26;var _31=_29.style,_32;if(_13===false||_25){_31.display=_26?"block":"none";_31.height="";}else{if(_26){_31.display="block";_32=_29.scrollHeight;_31.height="0px";}else{_9(_29,".dgrid-tree-resetting");_31.height=_29.scrollHeight+"px";}setTimeout(function(){_9(_29,"!dgrid-tree-resetting");_31.height=_26?(_32?_32+"px":"auto"):"0px";});}if(_26){this._expanded[row.id]=true;}else{delete this._expanded[row.id];}}};_6.after(_a,"destroy",function(){_2.forEach(_14,function(l){l.remove();});delete _11.expand;delete _11._calcRowHeight;});});_a.renderCell=function(_33,_34,td,_35){var _36=_a.grid,_37=Number(_35&&_35.query&&_35.query.level)+1,_38=!_36.store.mayHaveChildren||_36.store.mayHaveChildren(_33),_39=_35.parentId,_3a,_3b;_37=_c=isNaN(_37)?0:_37;_3a=_a.renderExpando(_37,_38,_36._expanded[(_39?_39+"-":"")+_36.store.getIdentity(_33)]);_3a.level=_37;_3a.mayHaveChildren=_38;_3b=_b.call(_a,_33,_34,td,_35);if(_3b&&_3b.nodeType){_9(td,_3a);_9(td,_3b);}else{td.insertBefore(_3a,td.firstChild);}};return _a;};});